Power analysis
================

There are several approaches to conduct power analyses for LMMs in `R`,
e.g.:  
- **simr**: Simulation-based function to estimate power of LMMs.  
- **mlpwr**: ML algorithm to find the optimal sample size and number of
time points.  
- **PowerAnalysisLM**: A Shiny app for (longitudinal) LLMs that account
for temporal dependencies in multi-level data.

# Example using `simr`:

``` r
# load package
library(simr)

# seed
set.seed(123)
```

**Planned study**:  
Intervention for patients with depression. Participants are randomized
to treatment vs control groups and complete weekly PHQ-9 assessments. A
linear mixed-effects model with random intercepts and slopes evaluates
the week × group interaction.

**Model outline**:  
`PHQ9 ~ time * group + (time | id)`

``` r
# create design data
id <- factor(1:40)
time <- 0:5
group <- c("control", "intervention")

df <- data.frame(id = rep(id, each = length(time)),
                   time = rep(time, length(id)),
                   group = rep(rep(group, each = length(time)), 
                               length(id)/2))

head(df, n = 20)
```

    ##    id time        group
    ## 1   1    0      control
    ## 2   1    1      control
    ## 3   1    2      control
    ## 4   1    3      control
    ## 5   1    4      control
    ## 6   1    5      control
    ## 7   2    0 intervention
    ## 8   2    1 intervention
    ## 9   2    2 intervention
    ## 10  2    3 intervention
    ## 11  2    4 intervention
    ## 12  2    5 intervention
    ## 13  3    0      control
    ## 14  3    1      control
    ## 15  3    2      control
    ## 16  3    3      control
    ## 17  3    4      control
    ## 18  3    5      control
    ## 19  4    0 intervention
    ## 20  4    1 intervention

**Plausible parameter values**:  
Fixed effects:  
`b0` (baseline mean, control): 14  
`b1` (weekly change, control): −0.2/week  
`b2` (baseline arm difference): 0  
`b3` (additional weekly change with treatment): −0.5/week

Random effects:  
`SD(b0)` (random intercept): 3 (Var = 9)  
`SD(b1)` (random slope per week): 0.25 (Var = 0.0625)  
`Corr(b0, b1)`: −0.3 (people starting higher tend to improve faster)

`Residual SD`: 2.5 (Var = 6.25)

``` r
# intercept and slopes for group, time, and group:time
fixed <- c(14, 0, -0.2, -0.5)

# random intercepts and slope (variance)
rand <- list(9, -0.3, 0.0625)

# residual (standard deviation)
res <- 2.5
```

**Standardized effect size**  
d<sub>GMA</sub> =  
( β<sub>3</sub> × T ) / SD<sub>pooled, pre</sub>  
= ( -0.5 × 5 ) / √(9 + 6.25)  
= ( -0.5 × 5 ) / 3.905  
≈ -0.64

**Fit model**

``` r
model <- makeLmer(y ~ group * time + (time|id),
                  fixef=fixed, VarCorr=rand, sigma=res, data=df)
summary(model)
```

    ## Linear mixed model fit by REML ['lmerMod']
    ## Formula: y ~ group * time + (time | id)
    ##    Data: df
    ## 
    ## REML criterion at convergence: 1318.9
    ## 
    ## Scaled residuals: 
    ##      Min       1Q   Median       3Q      Max 
    ## -2.58097 -0.67273 -0.01914  0.68567  2.93357 
    ## 
    ## Random effects:
    ##  Groups   Name        Variance Std.Dev. Corr 
    ##  id       (Intercept) 9.0000   3.0000        
    ##           time        0.1525   0.3905   -0.77
    ##  Residual             6.2500   2.5000        
    ## Number of obs: 240, groups:  id, 40
    ## 
    ## Fixed effects:
    ##                        Estimate Std. Error t value
    ## (Intercept)             14.0000     0.7834  17.871
    ## groupintervention        0.0000     1.1079   0.000
    ## time                    -0.2000     0.1596  -1.253
    ## groupintervention:time  -0.5000     0.2258  -2.215
    ## 
    ## Correlation of Fixed Effects:
    ##             (Intr) grpntr time  
    ## gropntrvntn -0.707              
    ## time        -0.717  0.507       
    ## grpntrvntn:  0.507 -0.717 -0.707

**Power analysis**

``` r
sim <- powerSim(model, nsim = 250, test = fixed("group:time"))
```

``` r
sim
```

    ## Power for predictor 'group:time', (95% confidence interval):
    ##       54.80% (48.41, 61.08)
    ## 
    ## Test: Kenward Roger (package pbkrtest)
    ## 
    ## Based on 250 simulations, (18 warnings, 0 errors)
    ## alpha = 0.05, nrow = 240
    ## 
    ## Time elapsed: 0 h 0 m 35 s

**Changing the number of participants**

``` r
model_ext_id <- extend(model, along = "id", n = 100)

p_curve <- powerCurve(model_ext_id, nsim = 250, 
                      test = fixed("group:time"), 
                      along = "id", 
                      breaks = c(20, 40, 60, 80, 100))
```

``` r
plot(p_curve)
```

![](5_files/figure-gfm/unnamed-chunk-9-1.png)<!-- -->

**Changing the number of timepoints**

``` r
model_ext_time <- extend(model, along = "time", n = 12)

p_curve <- powerCurve(model_ext_time, nsim = 250, 
                      test = fixed("group:time"), 
                      along = "time", 
                      breaks = c(4, 6, 8, 10, 12))
```

``` r
plot(p_curve)
```

![](5_files/figure-gfm/unnamed-chunk-11-1.png)<!-- -->

**Changing both the number of participants and timepoints**

``` r
# create design data
id <- factor(1:80)
time <- 1:8
group <- c("control", "intervention")

data <- data.frame(id = rep(id, each = length(time)),
                   time = rep(time, length(id)),
                   group = rep(rep(group, each = length(time)), 
                               length(id)/2))

# fit model
model_final <- makeLmer(y ~ group*time + (time|id),
                  fixef=fixed, VarCorr=rand, sigma=res, data=data)

# power analysis
sim <- powerSim(model_final, nsim = 250, test = fixed("group:time"))
```

``` r
sim
```

    ## Power for predictor 'group:time', (95% confidence interval):
    ##       97.20% (94.32, 98.87)
    ## 
    ## Test: Kenward Roger (package pbkrtest)
    ## 
    ## Based on 250 simulations, (110 warnings, 0 errors)
    ## alpha = 0.05, nrow = 640
    ## 
    ## Time elapsed: 0 h 0 m 39 s

# Exercises

1.  Estimate the sample size needed to test a difference in treatment vs
    control group .

2.  Estimate the power of the `eventpl` effect in model `m3`. (`simr`
    will throw a warning on post-hoc power analysis.)
