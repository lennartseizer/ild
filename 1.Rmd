---
title: "My Page"
output:
  html_document:
    self_contained: no
---

Preprocessing can be organized along a reproducible workflow: (1) understand the study design, (2) reliably import the raw data, (3) validate measurement windows, (4) classify missing and problematic observations, (5) compute scales and derived variables, (6) generate the analysis dataset for the target model (e.g., LMM). Each step should be documented in scripts to ensure that the analyses remain transparent and reproducible. 

```{r, message=FALSE}
library(dplyr)
library(ggplot2)
```

```{r, message=FALSE}
# load example data
data <- read.delim("https://www.kuleuven.be/samenwerking/real/real-book/viechtbauer2022_data_esmda_example")

dplyr::tibble(data)
```

**Design variables**: the study `day` (1 to 6), the `beep` number within
each day (1 to 10) and `beeptime` (in minutes after midnight) on each day, the overall number of observations `obs` (1 to 60), the response time `resptime` (in minutes after midnight)

**Subject-level, time-invariant variables**: the participants' `age` (in years), `sex` (female, male), and mental
health `status` (control, depressed, psychotic)  

**Time-varying response variables**: 3 items to assess positive affect and 6 items to assess negative affect (1 to 7 Likert scale), the pleasantness of events that had occurred since the previous beep `eventpl` (âˆ’3 to +3 bipolar scale), whether the person was alone at the time of the beep `soc_alone` (1 = alone, 0 = not alone) and when the person was not alone) a rating how pleasant the company is `soc_pleasant` (1 to 7 Likert scale), and whether they had consumed coffee / alcohol since the previous beep (1 = yes, 0 = no)

# Design and sampling scheme

```{r}
# number of participants
length(unique(data$id))

# number of planned observations 
nrow(data)
```

```{r}
# missing values in design variables?

```

```{r, message=FALSE}
# variance in time-invariant variables?
vars <- c("age", "sex", "status")

data %>%
  group_by(id) %>%
  summarise(across(all_of(vars), ~ n_distinct(.) == 1), .groups = "drop") %>%
  summarise(across(all_of(vars), all))

# investigate further
data %>%
  group_by(id) %>%
  summarise(across(all_of(vars), n_distinct)) %>%
  mutate(across(all_of(vars), ~ .x == 1))
```

# Participants response behaviors

```{r}
# compute the response frequencies
data$compl <- !is.na(data$resptime)

# histogram of the response frequencies
hist(aggregate(data, compl ~ id, sum)$compl, main = "Response Frequency",
     col="lightgray", xlab="Number of assessments", right=FALSE)

# histogram of the compliance
hist(aggregate(data, compl ~ id, sum)$compl / 60, main = "Response Frequency",
     col="lightgray", xlab="Percentage of assessments", right=FALSE)

# summary of compliance
summary(aggregate(data, compl ~ id, sum)$compl / 60)
```

```{r}
# compute response delays
data$delay <- data$resptime - data$beeptime

# barplot of the delay values
barplot(table(data$delay), xlab="Delay in Minutes")
```

# Compute and transform variables

```{r}
# compute scales of positive and negative affect
data$pa <- rowMeans(data[,c("mood_cheerf", "mood_relaxed", "mood_satisfi")])

data$na <- rowMeans(data[,c("mood_irritat", "mood_anxious", "mood_down", 
                            "mood_guilty", "mood_insecur", "mood_lonely")])
```

```{r}
# separate variables into within and between parts

# positive affect
data$pa_b <- ave(data$pa, data$id, FUN=function(x)mean(x, na.rm = TRUE)) # person-mean (between)
data$pa_w <- data$pa - data$pa_b # person-mean centered (within)

# negative affect
data$na_b <- ave(data$na, data$id, FUN=function(x)mean(x, na.rm = TRUE)) # person-mean (between)
data$na_w <- data$na - data$na_b # person-mean centered (within)

tibble(data[,c("id","pa","pa_b","pa_w")])
```

# visualization

```{r, message=FALSE}
id_select <- "c100"

data %>% filter(id %in% id_select) %>%
     ggplot(aes(x = obs, y = pa)) +
     geom_line() +
     geom_point() +
     facet_grid(id ~ ., scales = "free") 
```

```{r, message=FALSE}
id_select <- c("c100", "c101", "c102", "c103", "c104")

data %>% filter(id %in% id_select) %>%
     ggplot(aes(x=obs, y=mood_relaxed)) +
     geom_line() +
     geom_point() +
     facet_grid(id~., scales="free") 
```

```{r, echo=FALSE}
# loop for time series plots
id_chunks <- seq(1, length(data$id), 5)

for (i in id_chunks) {
data %>% filter(id %in% data$id[i:i+4]) %>%
     ggplot(aes(x=obs, y=mood_relaxed)) +
     geom_line() +
     geom_point() +
     facet_grid(id~., scales="free")
}
```

```{r}
# plot within and between parts
data %>% filter(id %in% id_select) %>%
     ggplot(aes(x = obs, y = pa_b)) +
     geom_line() +
     geom_point() 

data %>% filter(id %in% id_select) %>%
     ggplot(aes(x = obs, y = pa_w)) +
     geom_line() +
     geom_point() 
```


# References & Further reading

