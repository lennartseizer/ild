Preprocessing
================

Preprocessing can be organized along a reproducible workflow: (1)
understand the study design, (2) reliably import the raw data, (3)
validate measurement windows, (4) classify missing and problematic
observations, (5) compute scales and derived variables, (6) generate the
analysis dataset for the target model (e.g., LMM). Each step should be
documented in scripts to ensure that the analyses remain transparent and
reproducible.

<figure>
<img src="https://www.researchgate.net/profile/Sheen-Levine/publication/325941519/figure/fig2/AS:824194581422080@1573514709439/The-Datasaurus-Dozen-Matejka-Fitzmaurice-2017-an-extension-of-Anscombes-quartet.ppm">
<figcaption>
The Datasaurus Dozen: All of them have identical descriptive statistics
(Matejka & Fitzmaurice, 2017).
</figcaption>
</figure>

``` r
library(dplyr)
library(ggplot2)
library(cowplot)
```

# Get data

``` r
# load example data
data <- read.delim("https://www.kuleuven.be/samenwerking/real/real-book/viechtbauer2022_data_esmda_example")

str(data)
```

    ## 'data.frame':    19680 obs. of  27 variables:
    ##  $ id          : chr  "c100" "c100" "c100" "c100" ...
    ##  $ age         : int  30 30 30 30 30 30 30 30 30 30 ...
    ##  $ sex         : chr  "female" "female" "female" "female" ...
    ##  $ status      : chr  "control" "control" "control" "control" ...
    ##  $ day         : int  1 1 1 1 1 1 1 1 1 1 ...
    ##  $ beep        : int  1 2 3 4 5 6 7 8 9 10 ...
    ##  $ obs         : int  1 2 3 4 5 6 7 8 9 10 ...
    ##  $ beeptime    : int  477 585 718 756 874 982 1079 1133 1215 1301 ...
    ##  $ resptime    : int  480 NA 721 759 876 988 1082 1138 1219 1304 ...
    ##  $ resphour    : num  8 NA 12 12.7 14.6 ...
    ##  $ tothours    : num  8 NA 12 12.7 14.6 ...
    ##  $ mood_cheerf : int  5 NA 6 4 5 6 4 6 5 4 ...
    ##  $ mood_relaxed: int  4 NA 5 4 4 4 4 5 5 4 ...
    ##  $ mood_satisfi: int  5 NA 5 4 4 5 4 5 5 5 ...
    ##  $ mood_irritat: int  1 NA 1 6 2 6 4 2 1 1 ...
    ##  $ mood_anxious: int  1 NA 1 1 1 1 1 1 1 1 ...
    ##  $ mood_down   : int  1 NA 1 6 1 1 1 1 1 1 ...
    ##  $ mood_guilty : int  1 NA 1 1 1 1 1 1 1 1 ...
    ##  $ mood_insecur: int  1 NA 1 1 1 1 1 1 1 1 ...
    ##  $ mood_lonely : int  1 NA 1 1 1 1 1 1 1 1 ...
    ##  $ eventpl     : int  0 NA 2 -2 3 NA 3 NA 3 2 ...
    ##  $ soc_alone   : int  0 NA 0 0 0 0 0 0 0 0 ...
    ##  $ soc_pleasant: int  7 NA 7 7 7 4 6 7 7 7 ...
    ##  $ act_else    : int  2 NA 1 7 2 7 6 3 1 7 ...
    ##  $ use_coffee  : int  0 NA 0 0 0 1 0 0 0 0 ...
    ##  $ use_alcohol : int  0 NA 0 0 0 0 0 0 0 0 ...
    ##  $ location    : chr  "home" "" "home" "home" ...

**Design variables**: the study `day` (1 to 6), the `beep` number within
each day (1 to 10) and `beeptime` (in minutes after midnight) on each
day, the overall number of observations `obs` (1 to 60), the response
time `resptime` (in minutes after midnight)

**Subject-level, time-invariant variables**: the participants’ `age` (in
years), `sex` (female, male), and mental health `status` (control,
depressed, psychotic)

**Time-varying response variables**: 3 items to assess positive affect
and 6 items to assess negative affect (1 to 7 Likert scale), the
pleasantness of events that had occurred since the previous beep
`eventpl` (−3 to +3 bipolar scale), whether the person was alone at the
time of the beep `soc_alone` (1 = alone, 0 = not alone) and when the
person was not alone) a rating how pleasant the company is
`soc_pleasant` (1 to 7 Likert scale), and whether they had consumed
coffee / alcohol since the previous beep (1 = yes, 0 = no)

<figure>
<img src="https://carpentry.library.ucsb.edu/2023-01-23-ucsb-r/fig/14-tidyr-fig3.png">
</figure>

# Design and sampling scheme

``` r
# number of participants
length(unique(data$id))
```

    ## [1] 328

``` r
# number of planned observations 
nrow(data)
```

    ## [1] 19680

``` r
# missing values in design variables?
design_vars <- c("id", "day", "beep", "beeptime", "obs")

data %>%
  summarise(across(all_of(design_vars), ~ any(is.na(.))))
```

    ##      id   day  beep beeptime   obs
    ## 1 FALSE FALSE FALSE    FALSE FALSE

``` r
# no variance in time-invariant variables?
l2_vars <- c("age", "sex", "status")

data %>%
  group_by(id) %>%
  summarise(across(all_of(l2_vars), ~ n_distinct(.) == 1), .groups = "drop") %>%
  summarise(across(all_of(l2_vars), all))
```

    ## # A tibble: 1 × 3
    ##   age   sex   status
    ##   <lgl> <lgl> <lgl> 
    ## 1 TRUE  TRUE  TRUE

# Participants response behaviors

``` r
# compute the response frequencies
data$compl <- !is.na(data$resptime)

# histogram of the response frequencies
p_comp1 <- ggplot(aggregate(data, compl ~ id, sum), aes(x = compl)) +
  geom_bar() + theme_minimal() + xlab("Number of assessments") +
  ggtitle("Response Frequency")

# histogram of the compliance
p_comp2 <- ggplot(aggregate(data, compl ~ id, sum), aes(x = compl / 60 * 100)) +
  geom_bar() + theme_minimal() + xlab("Number of assessments") +
  ggtitle("Response Frequency")

plot_grid(p_comp1, p_comp2)

# summary of compliance
summary(aggregate(data, compl ~ id, sum)$compl / 60 * 100)
```

    ##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    ##   33.33   65.00   77.50   75.67   88.33  100.00

![](2_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->

``` r
# compute response delays
data$delay <- data$resptime - data$beeptime

# barplot of the delay values
barplot(table(data$delay), xlab="Delay in Minutes")
```

<img src="2_files/figure-gfm/unnamed-chunk-8-1.png" width="50%" />

# Compute and transform variables

``` r
# check distributions and out-of-range values
barplot(table(data$mood_relaxed), main = "Mood: Relaxed")
barplot(table(data$mood_down), main = "Mood: Down")
barplot(table(data$eventpl), main = "Event pleaseantness")
barplot(table(data$age), main = "Age")
```

<img src="2_files/figure-gfm/unnamed-chunk-9-1.png" width="50%" /><img src="2_files/figure-gfm/unnamed-chunk-9-2.png" width="50%" /><img src="2_files/figure-gfm/unnamed-chunk-9-3.png" width="50%" /><img src="2_files/figure-gfm/unnamed-chunk-9-4.png" width="50%" />

``` r
# summary of L2-variables
head(aggregate(data, age ~ id, unique))
```

    ##     id age
    ## 1 c100  30
    ## 2 c101  32
    ## 3 c102  33
    ## 4 c103  47
    ## 5 c104  30
    ## 6 c105  35

``` r
# compute scales of positive and negative affect
data$pa <- rowMeans(data[,c("mood_cheerf", "mood_relaxed", "mood_satisfi")])

data$na <- rowMeans(data[,c("mood_irritat", "mood_anxious", "mood_down", 
                            "mood_guilty", "mood_insecur", "mood_lonely")])
```

``` r
# separate variables into within and between parts

# positive affect
data$pa_b <- ave(data$pa, data$id, FUN=function(x)mean(x, na.rm = TRUE)) # person-mean (between)
data$pa_w <- data$pa - data$pa_b # person-mean centered (within)

# negative affect
data$na_b <- ave(data$na, data$id, FUN=function(x)mean(x, na.rm = TRUE)) # person-mean (between)
data$na_w <- data$na - data$na_b # person-mean centered (within)

tibble(data[,c("id","pa","pa_b","pa_w")])
```

    ## # A tibble: 19,680 × 4
    ##    id       pa  pa_b   pa_w
    ##    <chr> <dbl> <dbl>  <dbl>
    ##  1 c100   4.67  5.12 -0.452
    ##  2 c100  NA     5.12 NA    
    ##  3 c100   5.33  5.12  0.215
    ##  4 c100   4     5.12 -1.12 
    ##  5 c100   4.33  5.12 -0.785
    ##  6 c100   5     5.12 -0.119
    ##  7 c100   4     5.12 -1.12 
    ##  8 c100   5.33  5.12  0.215
    ##  9 c100   5     5.12 -0.119
    ## 10 c100   4.33  5.12 -0.785
    ## # ℹ 19,670 more rows

# visualization

``` r
id_select <- "c100"

data %>% filter(id %in% id_select) %>%
     ggplot(aes(x = obs, y = pa)) +
     geom_line() +
     geom_point() +
     facet_grid(id ~ ., scales = "free") 
```

    ## Warning: Removed 15 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

![](2_files/figure-gfm/unnamed-chunk-13-1.png)<!-- -->

``` r
id_select <- c("c100", "c101", "c102", "c103", "c104")

data %>% filter(id %in% id_select) %>%
     ggplot(aes(x=obs, y=mood_relaxed)) +
     geom_line() +
     geom_point() +
     facet_grid(id~., scales="free") 
```

    ## Warning: Removed 41 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

![](2_files/figure-gfm/unnamed-chunk-14-1.png)<!-- -->

# References & Further reading

Matejka, J., & Fitzmaurice, G. (2017). Same stats, different graphs:
generating datasets with varied appearance and identical statistics
through simulated annealing. In Proceedings of the 2017 CHI conference
on human factors in computing systems (pp. 1290-1294).
