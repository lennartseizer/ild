---
title: "Preprocessing"
---

```{r, include=FALSE}
install.packages("dplyr")
install.packages("ggplot2")
install.packages("cowplot")
```

Preprocessing can be organized along a reproducible workflow: (1) understand the study design, (2) reliably import the raw data, (3) validate measurement windows, (4) classify missing and problematic observations, (5) compute scales and derived variables, (6) generate the analysis dataset for the target model (e.g., LMM). Each step should be documented in scripts to ensure that the analyses remain transparent and reproducible. 

<figure>
    <img src="https://www.researchgate.net/profile/Sheen-Levine/publication/325941519/figure/fig2/AS:824194581422080@1573514709439/The-Datasaurus-Dozen-Matejka-Fitzmaurice-2017-an-extension-of-Anscombes-quartet.ppm">
    <figcaption>The Datasaurus Dozen: All of them have identical descriptive statistics (Matejka & Fitzmaurice, 2017).
  </figcaption>
</figure>

```{r, message=FALSE}
library(dplyr)
library(ggplot2)
library(cowplot)
```

# Get data

```{r, message=FALSE}
# load example data
data <- read.delim("https://www.kuleuven.be/samenwerking/real/real-book/viechtbauer2022_data_esmda_example")

str(data)
```

**Design variables**: the study `day` (1 to 6), the `beep` number within
each day (1 to 10) and `beeptime` (in minutes after midnight) on each day, the overall number of observations `obs` (1 to 60), the response time `resptime` (in minutes after midnight)

**Subject-level, time-invariant variables**: the participants' `age` (in years), `sex` (female, male), and mental
health `status` (control, depressed, psychotic)  

**Time-varying response variables**: 3 items to assess positive affect and 6 items to assess negative affect (1 to 7 Likert scale), the pleasantness of events that had occurred since the previous beep `eventpl` (âˆ’3 to +3 bipolar scale), whether the person was alone at the time of the beep `soc_alone` (1 = alone, 0 = not alone) and when the person was not alone) a rating how pleasant the company is `soc_pleasant` (1 to 7 Likert scale), and whether they had consumed coffee / alcohol since the previous beep (1 = yes, 0 = no)

<figure>
    <img src="https://carpentry.library.ucsb.edu/2023-01-23-ucsb-r/fig/14-tidyr-fig3.png">
</figure>

# Design and sampling scheme

```{r}
# number of participants
length(unique(data$id))

# number of planned observations 
nrow(data)
```

```{r}
# missing values in design variables?
design_vars <- c("id", "day", "beep", "beeptime", "obs")

data %>%
  summarise(across(all_of(design_vars), ~ any(is.na(.))))
```

```{r, message=FALSE}
# no variance in time-invariant variables?
l2_vars <- c("age", "sex", "status")

data %>%
  group_by(id) %>%
  summarise(across(all_of(l2_vars), ~ n_distinct(.) == 1), .groups = "drop") %>%
  summarise(across(all_of(l2_vars), all))
```

# Participants response behaviors

```{r, fig.show="hold"}
# compute the response frequencies
data$compl <- !is.na(data$resptime)

# histogram of the response frequencies
p_comp1 <- ggplot(aggregate(data, compl ~ id, sum), aes(x = compl)) +
  geom_bar() + theme_minimal() + xlab("Number of assessments") +
  ggtitle("Response Frequency")

# histogram of the compliance
p_comp2 <- ggplot(aggregate(data, compl ~ id, sum), aes(x = compl / 60 * 100)) +
  geom_bar() + theme_minimal() + xlab("Number of assessments") +
  ggtitle("Response Frequency")

plot_grid(p_comp1, p_comp2)

# summary of compliance
summary(aggregate(data, compl ~ id, sum)$compl / 60 * 100)
```

```{r, fig.show="hold", out.width="50%"}
# compute response delays
data$delay <- data$resptime - data$beeptime

# barplot of the delay values
barplot(table(data$delay), xlab="Delay in Minutes")
```

# Compute and transform variables

```{r, fig.show="hold", out.width="50%"}
# check distributions and out-of-range values
barplot(table(data$mood_relaxed), main = "Mood: Relaxed")
barplot(table(data$mood_down), main = "Mood: Down")
barplot(table(data$eventpl), main = "Event pleaseantness")
barplot(table(data$age), main = "Age")
```

```{r}
# summary of L2-variables
head(aggregate(data, age ~ id, unique))
```

```{r}
# compute scales of positive and negative affect
data$pa <- rowMeans(data[,c("mood_cheerf", "mood_relaxed", "mood_satisfi")])

data$na <- rowMeans(data[,c("mood_irritat", "mood_anxious", "mood_down", 
                            "mood_guilty", "mood_insecur", "mood_lonely")])
```

```{r}
# separate variables into within and between parts

# positive affect
data$pa_b <- ave(data$pa, data$id, FUN=function(x)mean(x, na.rm = TRUE)) # person-mean (between)
data$pa_w <- data$pa - data$pa_b # person-mean centered (within)

# negative affect
data$na_b <- ave(data$na, data$id, FUN=function(x)mean(x, na.rm = TRUE)) # person-mean (between)
data$na_w <- data$na - data$na_b # person-mean centered (within)

tibble(data[,c("id","pa","pa_b","pa_w")])
```

# visualization

```{r, message=FALSE}
id_select <- "c100"

data %>% filter(id %in% id_select) %>%
     ggplot(aes(x = obs, y = pa)) +
     geom_line() +
     geom_point() +
     facet_grid(id ~ ., scales = "free") 
```

```{r, message=FALSE}
id_select <- c("c100", "c101", "c102", "c103", "c104")

data %>% filter(id %in% id_select) %>%
     ggplot(aes(x=obs, y=mood_relaxed)) +
     geom_line() +
     geom_point() +
     facet_grid(id~., scales="free") 
```

```{r, echo=FALSE, fig.show="hold", out.width="50%"}
# loop for time series plots
id_chunks <- seq(1, length(data$id), 5)

for (i in id_chunks) {
data %>% filter(id %in% data$id[i:i+4]) %>%
     ggplot(aes(x=obs, y=mood_relaxed)) +
     geom_line() +
     geom_point() +
     facet_grid(id~., scales="free")
}
```

```{r}
# plot within and between parts
data %>% filter(id %in% id_select) %>%
     ggplot(aes(x = obs, y = pa_b)) +
     geom_line() +
     geom_point() 

data %>% filter(id %in% id_select) %>%
     ggplot(aes(x = obs, y = pa_w)) +
     geom_line() +
     geom_point() 
```

# References & Further reading

Matejka, J., & Fitzmaurice, G. (2017). Same stats, different graphs: generating datasets with varied appearance and identical statistics through simulated annealing. In Proceedings of the 2017 CHI conference on human factors in computing systems (pp. 1290-1294).
