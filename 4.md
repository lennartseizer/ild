Fitting mixed-effects models
================

| Feature / Task                 | **lme4 (lmer)**                          | **nlme (lme)**                           |
|--------------------------------|------------------------------------------|------------------------------------------|
| Main function                  | `lmer()`                                 | `lme()`                                  |
| Syntax for random intercepts   | `lmer(y ~ 1 + (1|id), data = df)`        | `lme(y ~ 1, random = ~1|id, data = df)`  |
| Random slopes                  | `lmer(y ~ x + (x|id), data = df)`        | `lme(y ~ x, random = ~x|id, data = df)`  |
| Multiple grouping factors      | Yes (nested/crossed)                     | Limited, mostly nested                   |
| Estimation method              | REML / ML (fast, sparse matrices)        | REML / ML (older implementation)         |
| Handles heteroscedasticity     | Not directly                             | Yes, via `weights = varIdent(...)`       |
| Correlation structures         | Not directly                             | Yes, via `corAR1`, `corCompSymm`, etc.   |
| Extract fixed effects          | `fixef(model)`                           | `fixef(model)`                           |
| Extract random effects (BLUPs) | `ranef(model)`                           | `ranef(model)`                           |
| Fitted values                  | `fitted(model)`                          | `fitted(model)`                          |
| P-values for fixed effects     | Not provided by default (use `lmerTest`) | Provided directly in summary output      |
| Speed / scalability            | Very fast, good for large data           | Slower, better for smaller/moderate data |

# Null model

``` r
# set environment
library(nlme)
library(lme4)
library(ggplot2)
library(cowplot)
library(scales)
library(r2mlm)
library(tidyr)
library(parameters)
```

``` r
# fit base model
m1 <- lme(pa ~ 1, 
          random = ~1|id,
          data = data, 
          na.action = na.omit)

summary(m1)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   43350.01 43372.82 -21672.01
    ## 
    ## Random effects:
    ##  Formula: ~1 | id
    ##         (Intercept) Residual
    ## StdDev:   0.9597608 1.004858
    ## 
    ## Fixed effects:  pa ~ 1 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.549196 0.05366659 14464 84.76775       0
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -5.2911753 -0.5171447  0.1007566  0.5907290  4.2945047 
    ## 
    ## Number of Observations: 14792
    ## Number of Groups: 328

``` r
# fixed effects
fixef(m1)
```

    ## (Intercept) 
    ##    4.549196

``` r
# random effects
head(ranef(m1))
```

    ##      (Intercept)
    ## c100   0.5557835
    ## c101   0.1352157
    ## c102  -0.3672321
    ## c103   2.1116416
    ## c104   1.8477497
    ## c105   1.5633701

``` r
# plot individual intercepts and residuals
hist1 <- ggplot(data.frame(value = coef(m1)[[1]]), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, color = "white") +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(x = "Average Positive Affect", y = "Density") +
  theme_bw()

hist2 <- ggplot(data.frame(value = resid(m1)), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, color = "white") +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(x = "Residual", y = "Density") +
  theme_bw()
  
plot_grid(hist1, hist2)
```

![](4_files/figure-gfm/unnamed-chunk-5-1.png)<!-- -->

**Shrinkage**: compare pooled estimates with non-pooled means

``` r
# compute individual means
indiv_means <- data %>%
  group_by(id) %>%
  summarise(indiv_mean = mean(pa, na.rm = TRUE)) %>%
  ungroup()

# plot pooled vs non-pooled means
hist1 <- ggplot(data.frame(value = coef(m1)[[1]]), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30) +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(title = "Average Positive Affect", x = "BLUPs") +
  theme_bw()

hist2 <- ggplot(data.frame(value = indiv_means$indiv_mean), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30) +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(title = "Average Positive Affect", x = "Observed means") +
  theme_bw()
  
plot_grid(hist1, hist2)
```

![](4_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->

``` r
# pooled vs non-pooled means
head(data.frame(BLUP = coef(m1)[[1]], 
                Obs_Means = indiv_means$indiv_mean))
```

    ##       BLUP Obs_Means
    ## 1 5.104980  5.118519
    ## 2 4.684412  4.687500
    ## 3 4.181964  4.175141
    ## 4 6.660838  6.703704
    ## 5 6.396946  6.435897
    ## 6 6.112566  6.151515

**ICC**: Intraclass Correlation Coefficient

``` r
int_var <- getVarCov(m1)[1,1] # random intercept variance
res_var <- sigma(m1)^2 # residual variance

int_var / (int_var + res_var)
```

    ## [1] 0.4770572

# Adding time as a predictor

``` r
# plot time variables
d <- data %>% filter(id == "c100") %>% mutate(idx = row_number())

t1 <- ggplot(d, aes(idx, obs)) + geom_line() + geom_point() + 
  labs(x="Index", y="obs") + theme_bw()
t2 <- ggplot(d, aes(idx, day)) + geom_line() + geom_point() + 
  labs(x="Index", y="day") + theme_bw()
t3 <- ggplot(d, aes(idx, beep)) + geom_line() + geom_point() + 
  labs(x="Index", y="beep") + theme_bw()
t4 <- ggplot(d, aes(idx, resptime)) + geom_line() + geom_point() + 
  labs(x="Index", y="resptime") + theme_bw()

plot_grid(t1, t2, t3, t4)
```

![](4_files/figure-gfm/unnamed-chunk-8-1.png)<!-- -->

**Variance decomposition based on time variables**

``` r
# intercept-only model with time-variance components 
m2_lme <- lme(pa ~ 1, 
              random = ~1|id/day/beep,
              data = data, 
              na.action = na.omit)

m2_lmer <- lmer(pa ~ 1 + (1|id) + (1|day) + (1 | beep) + (1|id:day) +
                  (1|id:beep) + (1|day:beep),
                data = data)

# model summaries
summary(m2_lme)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   42294.84 42332.85 -21142.42
    ## 
    ## Random effects:
    ##  Formula: ~1 | id
    ##         (Intercept)
    ## StdDev:    0.943853
    ## 
    ##  Formula: ~1 | day %in% id
    ##         (Intercept)
    ## StdDev:   0.4587877
    ## 
    ##  Formula: ~1 | beep %in% day %in% id
    ##         (Intercept)  Residual
    ## StdDev:   0.8407292 0.3576609
    ## 
    ## Fixed effects:  pa ~ 1 
    ##                Value  Std.Error    DF t-value p-value
    ## (Intercept) 4.550016 0.05373061 12850  84.682       0
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -2.18303557 -0.18747563  0.03813596  0.21591511  1.53929769 
    ## 
    ## Number of Observations: 14792
    ## Number of Groups: 
    ##                    id           day %in% id beep %in% day %in% id 
    ##                   328                  1942                 14792

``` r
summary(m2_lmer)
```

    ## Linear mixed model fit by REML ['lmerMod']
    ## Formula: pa ~ 1 + (1 | id) + (1 | day) + (1 | beep) + (1 | id:day) + (1 |  
    ##     id:beep) + (1 | day:beep)
    ##    Data: data
    ## 
    ## REML criterion at convergence: 42190.9
    ## 
    ## Scaled residuals: 
    ##     Min      1Q  Median      3Q     Max 
    ## -5.5256 -0.4696  0.0917  0.5460  3.8197 
    ## 
    ## Random effects:
    ##  Groups   Name        Variance  Std.Dev. 
    ##  id:beep  (Intercept) 2.289e-02 1.513e-01
    ##  id:day   (Intercept) 2.134e-01 4.620e-01
    ##  id       (Intercept) 8.905e-01 9.437e-01
    ##  day:beep (Intercept) 1.767e-09 4.203e-05
    ##  beep     (Intercept) 7.440e-03 8.625e-02
    ##  day      (Intercept) 0.000e+00 0.000e+00
    ##  Residual             8.055e-01 8.975e-01
    ## Number of obs: 14792, groups:  
    ## id:beep, 3226; id:day, 1942; id, 328; day:beep, 60; beep, 10; day, 6
    ## 
    ## Fixed effects:
    ##             Estimate Std. Error t value
    ## (Intercept)  4.54171    0.06031    75.3
    ## optimizer (nloptwrap) convergence code: 0 (OK)
    ## boundary (singular) fit: see help('isSingular')

``` r
# extract variance components
vc <- as.data.frame(VarCorr(m2_lmer)) %>%
  group_by(grp) %>%
  summarise(vcov = sum(vcov), .groups = "drop") %>%
  mutate(Prop = vcov / sum(vcov)) %>%
  arrange(Prop)

# clearer plot: sorted horizontal bars with percent labels
ggplot(vc, aes(x = Prop, y = reorder(grp, Prop), fill = grp)) +
  geom_col(width = 0.7, color = "white", show.legend = FALSE) +
  geom_text(aes(label = percent(Prop, accuracy = 0.1)),
            hjust = -0.1, size = 3.2) +
  scale_x_continuous(labels = percent_format(accuracy = 1),
                     expand = expansion(mult = c(0, 0.1))) +
  labs(title = "Variance decomposition for PA",
       x = "Proportion of variance", y = NULL) +
  theme_bw(base_size = 12) 
```

![](4_files/figure-gfm/unnamed-chunk-9-1.png)<!-- -->

# Adding a L1 predictor

``` r
# fit model with predictor
m3 <- lme(pa ~ eventpl_w, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.omit)

summary(m3)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39707.38 39752.68 -19847.69
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9573536 (Intr)
    ## eventpl_w   0.1056453 -0.327
    ## Residual    0.9436220       
    ## 
    ## Fixed effects:  pa ~ eventpl_w 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.553894 0.05352444 13710 85.08065       0
    ## eventpl_w   0.189554 0.00813576 13710 23.29885       0
    ##  Correlation: 
    ##           (Intr)
    ## eventpl_w -0.232
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.78952092 -0.50284000  0.09444534  0.59143420  4.38937466 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

``` r
# fixed effects
fixef(m3)
```

    ## (Intercept)   eventpl_w 
    ##    4.553894    0.189554

``` r
# random effects
head(ranef(m3))
```

    ##      (Intercept)   eventpl_w
    ## c100   0.5731350 -0.03132804
    ## c101   0.1362071 -0.08478598
    ## c102  -0.3696322  0.02588976
    ## c103   2.1087963 -0.03187367
    ## c104   1.7994943 -0.07237153
    ## c105   1.5605030  0.01566165

**Plot estimates**

``` r
# extract random estimates
cf <- as.data.frame(coef(m3))
names(cf)[1:2] <- c("Intercept", "Slope") 
res_df <- data.frame(Residual = resid(m3))

# intercepts
p_int <- ggplot(cf, aes(x = Intercept)) +
  geom_histogram(bins = 30, aes(y = after_stat(density))) +
  geom_density(linewidth = 0.8, color = "blue") +
  labs(x = "Intercepts", y = "Density") + theme_bw()

# slopes
p_slope <- ggplot(cf, aes(x = Slope)) +
  geom_histogram(bins = 30, aes(y = after_stat(density))) +
  geom_density(linewidth = 0.8, color = "blue") +
  labs(x = "Slopes", y = "Density") + theme_bw()

# residuals
p_res <- ggplot(res_df, aes(x = Residual)) +
  geom_histogram(bins = 30, aes(y = after_stat(density))) +
  geom_density(linewidth = 0.8, color = "blue") +
  labs(x = "Residuals", y = "Density") + theme_bw()

# intercept vs slope with fixed-effect reference lines
p_scatter <- ggplot(cf, aes(x = Intercept, y = Slope)) +
  geom_point(alpha = 0.6) + 
  geom_vline(xintercept = as.numeric(fixef(m3)[1]), linetype = "dotted") +
  geom_hline(yintercept = as.numeric(fixef(m3)[2]), linetype = "dotted") +
  labs(x = "Intercept", y = "Slope") + theme_bw()

# plot
plot_grid(p_int, p_slope, p_res, p_scatter)
```

![](4_files/figure-gfm/unnamed-chunk-12-1.png)<!-- -->

**Explained variance**

``` r
# decomposition
r2mlm_manual(
  data = data %>% select(all_of(all.vars(formula(m3)))) %>% drop_na(), 
  within_covs = c("eventpl_w"),
  between_covs = NULL,
  random_covs = c("eventpl_w"),
  gamma_w = unname(fixef(m3)["eventpl_w"]),
  gamma_b = unname(fixef(m3)[c("(Intercept)")]),
  Tau = as.matrix(getVarCov(m3)),
  sigma2 = sigma(m3)^2
)
```

![](4_files/figure-gfm/unnamed-chunk-13-1.png)<!-- -->

**Nakagawa’s R2** $$
R^2_m = \frac{\sigma^2_{\text{fixed}}}
              {\sigma^2_{\text{fixed}} + \sigma^2_{\text{random}} + \sigma^2_{\text{residual}}}
\ \ \ \ 
R^2_c = \frac{\sigma^2_{\text{fixed}} + \sigma^2_{\text{random}}}
              {\sigma^2_{\text{fixed}} + \sigma^2_{\text{random}} + \sigma^2_{\text{residual}}}
$$

``` r
# extract variances
var_fixed <- var(predict(m3, level = 0), na.rm = T)
var_rand  <- sum(diag(as.matrix(getVarCov(m3))))
var_res <- sigma(m3)^2

# calculate R2s
R2m <- var_fixed / (var_fixed + var_rand + var_res)
R2c <- (var_fixed + var_rand) / (var_fixed + var_rand + var_res)
c(R2_marginal = R2m, R2_conditional = R2c)
```

    ##    R2_marginal R2_conditional 
    ##     0.04651119     0.53302709

``` r
# with helper function
performance::r2(m3)
```

    ## # R2 for Mixed Models
    ## 
    ##   Conditional R2: 0.537
    ##      Marginal R2: 0.046

# Adding covariates

**L2 covariate**

``` r
# fit model with L2 covariates
m4 <- lme(pa ~ eventpl_w + eventpl_bc + age, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.omit)

summary(m4)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39640.81 39701.21 -19812.41
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.8392212 (Intr)
    ## eventpl_w   0.1053072 -0.307
    ## Residual    0.9436622       
    ## 
    ## Fixed effects:  pa ~ eventpl_w + eventpl_bc + age 
    ##                 Value  Std.Error    DF   t-value p-value
    ## (Intercept)  4.821536 0.16167466 13710 29.822461  0.0000
    ## eventpl_w    0.192174 0.00812969 13710 23.638562  0.0000
    ## eventpl_bc   0.628619 0.06526251   325  9.632156  0.0000
    ## age         -0.007342 0.00423766   325 -1.732530  0.0841
    ##  Correlation: 
    ##            (Intr) evntpl_w evntpl_b
    ## eventpl_w  -0.049                  
    ## eventpl_bc  0.023  0.033           
    ## age        -0.957 -0.014   -0.024  
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.78149293 -0.50255156  0.08941963  0.59530938  4.40600475 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

``` r
# fixed effects
fixef(m4)
```

    ##  (Intercept)    eventpl_w   eventpl_bc          age 
    ##  4.821536305  0.192174115  0.628618704 -0.007341882

``` r
# random effects
head(ranef(m4))
```

    ##      (Intercept)   eventpl_w
    ## c100 -0.10143439 -0.01485745
    ## c101 -0.01720417 -0.08346298
    ## c102 -0.69510107  0.03258864
    ## c103  1.29768456 -0.01077876
    ## c104  1.84813900 -0.07636327
    ## c105  1.19444257  0.01961874

``` r
# grand-mean center age
data$age_c <- data$age - mean(aggregate(data, age ~ id, unique)$age)

# fit model with L2 covariate
m4_c <- lme(pa ~ eventpl_w + eventpl_bc + age_c, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.omit)

summary(m4_c)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39640.81 39701.21 -19812.41
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.8392211 (Intr)
    ## eventpl_w   0.1053072 -0.307
    ## Residual    0.9436622       
    ## 
    ## Fixed effects:  pa ~ eventpl_w + eventpl_bc + age_c 
    ##                 Value  Std.Error    DF  t-value p-value
    ## (Intercept)  4.553893 0.04709215 13710 96.70175  0.0000
    ## eventpl_w    0.192174 0.00812969 13710 23.63856  0.0000
    ## eventpl_bc   0.628619 0.06526251   325  9.63216  0.0000
    ## age_c       -0.007342 0.00423766   325 -1.73253  0.0841
    ##  Correlation: 
    ##            (Intr) evntpl_w evntpl_b
    ## eventpl_w  -0.216                  
    ## eventpl_bc  0.000  0.033           
    ## age_c      -0.004 -0.014   -0.024  
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.78149296 -0.50255157  0.08941958  0.59530936  4.40600471 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

**Explained variance**

``` r
# decomposition
r2mlm_manual(
  data = data %>% select(all_of(all.vars(formula(m4)))) %>% drop_na(), 
  within_covs = c("eventpl_w"),
  between_covs = c("eventpl_bc","age"),
  random_covs = c("eventpl_w"),
  gamma_w = unname(fixef(m4)["eventpl_w"]),
  gamma_b = unname(fixef(m4)[c("(Intercept)","eventpl_bc","age")]),
  Tau = as.matrix(getVarCov(m4)),
  sigma2 = sigma(m4)^2
)
```

![](4_files/figure-gfm/unnamed-chunk-18-1.png)<!-- -->

**Nakagawa’s R2**

``` r
performance::r2(m4)
```

    ## # R2 for Mixed Models
    ## 
    ##   Conditional R2: 0.532
    ##      Marginal R2: 0.148

**L1 covariate**

``` r
# fit model with L1 covariate
m5 <- lme(pa ~ eventpl_w + use_alcohol, 
          random = ~eventpl_w + use_alcohol|id,
          data = data, 
          na.action = na.omit)

summary(m5)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39129.37 39204.72 -19554.69
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w + use_alcohol | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr         
    ## (Intercept) 0.9566027 (Intr) evntp_
    ## eventpl_w   0.1036092 -0.331       
    ## use_alcohol 0.2762428 -0.099  0.478
    ## Residual    0.9413194              
    ## 
    ## Fixed effects:  pa ~ eventpl_w + use_alcohol 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.539428 0.05354383 13505 84.77967       0
    ## eventpl_w   0.187063 0.00808038 13505 23.15031       0
    ## use_alcohol 0.222355 0.04235498 13505  5.24980       0
    ##  Correlation: 
    ##             (Intr) evntp_
    ## eventpl_w   -0.231       
    ## use_alcohol -0.071  0.096
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.80268048 -0.50749011  0.09958159  0.58167250  4.10268353 
    ## 
    ## Number of Observations: 13835
    ## Number of Groups: 328

> `lme4` **package vignette:**  
> *There is not yet consensus about how to deal with singularity, or
> more generally to choose which random-effects specification (from a
> range of choices of varying complexity) to use. Some proposals
> include:*  
> \* *avoid fitting overly complex models in the first place,
> i.e. design experiments/restrict models a priori such that the
> variance-covariance matrices can be estimated precisely enough to
> avoid singularity (Matuschek et al 2017)*  
> - *use some form of model selection to choose a model that balances
> predictive accuracy and overfitting/type I error (Bates et al 2015,
> Matuschek et al 2017)*  
> *- “keep it maximal”, i.e. fit the most complex model consistent with
> the experimental design, removing only terms required to allow a
> non-singular fit (Barr et al. 2013), or removing further terms based
> on p-values or AIC*

``` r
# example RQ: PA <- eventpl within-participants
# covariates: use_alcohol, use_coffee

# base model
m6 <- lme(pa ~ eventpl_bc + use_alcohol + use_coffee, 
          random = ~1|id,
          data = data, 
          na.action = na.omit)

# random effect for use_alcohol
m7 <- lme(pa ~ eventpl_bc + use_alcohol + use_coffee, 
          random = ~use_alcohol|id,
          data = data, 
          na.action = na.omit)

anova(m6, m7)
```

    ##    Model df      AIC      BIC    logLik   Test  L.Ratio p-value
    ## m6     1  6 42489.69 42535.19 -21238.84                        
    ## m7     2  8 42474.28 42534.94 -21229.14 1 vs 2 19.40884   1e-04

``` r
# random effect for use_coffee
m8 <- lme(pa ~ eventpl_bc + use_alcohol + use_coffee, 
          random = ~use_coffee|id,
          data = data, 
          na.action = na.omit)

anova(m6, m8)
```

    ##    Model df      AIC      BIC    logLik   Test  L.Ratio p-value
    ## m6     1  6 42489.69 42535.19 -21238.84                        
    ## m8     2  8 42489.32 42549.99 -21236.66 1 vs 2 4.367015  0.1126

``` r
# final model
m8 <- lme(pa ~ eventpl_w + eventpl_bc + use_alcohol + use_coffee, 
          random = ~eventpl_w + use_alcohol|id,
          data = data, 
          na.action = na.omit)

summary(m8)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC   logLik
    ##   39060.39 39150.81 -19518.2
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w + use_alcohol | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr         
    ## (Intercept) 0.8437221 (Intr) evntp_
    ## eventpl_w   0.1031559 -0.321       
    ## use_alcohol 0.2740129 -0.115  0.466
    ## Residual    0.9413226              
    ## 
    ## Fixed effects:  pa ~ eventpl_w + eventpl_bc + use_alcohol + use_coffee 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.528802 0.04776037 13504 94.82341  0.0000
    ## eventpl_w   0.189385 0.00806775 13504 23.47430  0.0000
    ## eventpl_bc  0.620475 0.06547176   326  9.47699  0.0000
    ## use_alcohol 0.229839 0.04242565 13504  5.41745  0.0000
    ## use_coffee  0.036886 0.02079589 13504  1.77373  0.0761
    ##  Correlation: 
    ##             (Intr) evntpl_w evntpl_b us_lch
    ## eventpl_w   -0.220                         
    ## eventpl_bc   0.001  0.033                  
    ## use_alcohol -0.091  0.090    0.000         
    ## use_coffee  -0.122 -0.006   -0.009    0.092
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.77079224 -0.50344815  0.09619936  0.59049496  4.12439674 
    ## 
    ## Number of Observations: 13835
    ## Number of Groups: 328

# Moderation analysis

**L2 moderation**

``` r
m9 <- lme(pa ~ eventpl_w * status, 
          random = ~eventpl|id,
          data = data,
          na.action = na.omit)

summary(m9)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##       AIC      BIC   logLik
    ##   39603.6 39679.09 -19791.8
    ## 
    ## Random effects:
    ##  Formula: ~eventpl | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev     Corr  
    ## (Intercept) 0.85019343 (Intr)
    ## eventpl     0.09240477 -0.253
    ## Residual    0.94334942       
    ## 
    ## Fixed effects:  pa ~ eventpl_w * status 
    ##                               Value  Std.Error    DF  t-value p-value
    ## (Intercept)                5.193222 0.07935982 13708 65.43893  0.0000
    ## eventpl_w                  0.134978 0.01316483 13708 10.25293  0.0000
    ## statusdepressed           -1.117244 0.11311412   325 -9.87714  0.0000
    ## statuspsychotic           -0.804489 0.11402375   325 -7.05545  0.0000
    ## eventpl_w:statusdepressed  0.125720 0.01797485 13708  6.99424  0.0000
    ## eventpl_w:statuspsychotic  0.019690 0.01933424 13708  1.01843  0.3085
    ##  Correlation: 
    ##                           (Intr) evntp_ sttsdp sttsps evntpl_w:sttsd
    ## eventpl_w                 -0.066                                    
    ## statusdepressed           -0.702  0.046                             
    ## statuspsychotic           -0.696  0.046  0.488                      
    ## eventpl_w:statusdepressed  0.048 -0.732 -0.077 -0.034               
    ## eventpl_w:statuspsychotic  0.045 -0.681 -0.032 -0.074  0.499        
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.79526215 -0.50643346  0.09221851  0.58937049  4.31712413 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

**L1 moderation**

``` r
m10 <- lme(pa ~ eventpl_w * soc_alone, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.omit)

summary(m10)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39460.81 39521.17 -19722.41
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9519488 (Intr)
    ## eventpl_w   0.1051427 -0.331
    ## Residual    0.9411400       
    ## 
    ## Fixed effects:  pa ~ eventpl_w * soc_alone 
    ##                         Value  Std.Error    DF  t-value p-value
    ## (Intercept)          4.609327 0.05369251 13641 85.84674  0.0000
    ## eventpl_w            0.192434 0.00927859 13641 20.73953  0.0000
    ## soc_alone           -0.140265 0.01777361 13641 -7.89173  0.0000
    ## eventpl_w:soc_alone -0.011059 0.01115748 13641 -0.99116  0.3216
    ##  Correlation: 
    ##                     (Intr) evntp_ soc_ln
    ## eventpl_w           -0.212              
    ## soc_alone           -0.131  0.039       
    ## eventpl_w:soc_alone  0.009 -0.483 -0.012
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.84254761 -0.50432160  0.09379403  0.58901165  4.40188573 
    ## 
    ## Number of Observations: 13972
    ## Number of Groups: 328

``` r
m10 <- lme(pa ~ eventpl_w * soc_alone, 
          random = ~eventpl_w * soc_alone|id,
          data = data, 
          na.action = na.omit)

summary(m10)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39458.37 39571.54 -19714.19
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w * soc_alone | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##                     StdDev    Corr                
    ## (Intercept)         0.9415892 (Intr) evntp_ soc_ln
    ## eventpl_w           0.1021925 -0.386              
    ## soc_alone           0.1647760  0.115 -0.158       
    ## eventpl_w:soc_alone 0.0510984  0.290 -0.013 -0.163
    ## Residual            0.9375508                     
    ## 
    ## Fixed effects:  pa ~ eventpl_w * soc_alone 
    ##                         Value  Std.Error    DF  t-value p-value
    ## (Intercept)          4.610299 0.05314844 13641 86.74383  0.0000
    ## eventpl_w            0.192156 0.00913959 13641 21.02458  0.0000
    ## soc_alone           -0.137483 0.02014576 13641 -6.82444  0.0000
    ## eventpl_w:soc_alone -0.010235 0.01161987 13641 -0.88085  0.3784
    ##  Correlation: 
    ##                     (Intr) evntp_ soc_ln
    ## eventpl_w           -0.243              
    ## soc_alone           -0.067 -0.010       
    ## eventpl_w:soc_alone  0.078 -0.467 -0.031
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.87169010 -0.50311017  0.09190973  0.58480598  4.41928250 
    ## 
    ## Number of Observations: 13972
    ## Number of Groups: 328

# Within-subject mediation analysis

<figure>
<img src="https://upload.wikimedia.org/wikipedia/commons/f/f8/Simple_Mediation_Model.png">
</figure>

``` r
library(reshape2)
```

    ## 
    ## Attaching package: 'reshape2'

    ## The following object is masked from 'package:tidyr':
    ## 
    ##     smiths

``` r
data_med <- data[, c("id", "obs", "soc_pleasant", "eventpl_w", "pa")]
data_med$m <- data_med$eventpl_w

data_med <- melt(
  data_med,
  id.vars   = c("id", "obs", "soc_pleasant", "eventpl_w"),
  measure.vars = c("m","pa"),              # <- explicitly stack m and pa
  variable.name = "dv",
  value.name    = "z"
)

# adding dummy variables
data_med$dv <- factor(data_med$dv, levels = c("m","pa"))  # mediator first
data_med$dm <- as.integer(data_med$dv == "m")
data_med$dy <- as.integer(data_med$dv == "pa")
data_med$obs <- scale(data_med$obs, center = TRUE, scale = FALSE)

# order by id and time
data_med <- data_med[order(data_med$id,data_med$obs),]
```

``` r
# fit mediation model

               # intercepts
m_med <- lme(z ~ 0 + dm + dy +  
               # prediction of mediator 
               dm:soc_pleasant + 
               # prediction of outcome
               dy:eventpl_w + dy:soc_pleasant,
               # random effects for all three paths
               random = ~ 0 + dm + dy | id,  
               # separate residual variance for each outcome
               weights = varIdent(form = ~ 1 | dv), 
               data=data_med,
               na.action=na.omit,
               control = lmeControl(opt = "optim"))

summary(m_med)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data_med 
    ##        AIC      BIC    logLik
    ##   54332.17 54409.44 -27156.08
    ## 
    ## Random effects:
    ##  Formula: ~0 + dm + dy | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##          StdDev     Corr  
    ## dm       0.05462702 dm    
    ## dy       0.85374435 -0.972
    ## Residual 1.53953999       
    ## 
    ## Variance function:
    ##  Structure: Different standard deviations per stratum
    ##  Formula: ~1 | dv 
    ##  Parameter estimates:
    ##         m        pa 
    ## 1.0000000 0.5920559 
    ## Fixed effects:  z ~ 0 + dm + dy + dm:soc_pleasant + dy:eventpl_w + dy:soc_pleasant 
    ##                     Value  Std.Error    DF   t-value p-value
    ## dm              -1.028828 0.07542244 16433 -13.64087       0
    ## dy               3.166840 0.07365986 16433  42.99274       0
    ## dm:soc_pleasant  0.189268 0.01272108 16433  14.87832       0
    ## dy:eventpl_w     0.158963 0.00657526 16433  24.17592       0
    ## dy:soc_pleasant  0.254864 0.00973170 16433  26.18905       0
    ##  Correlation: 
    ##                 dm     dy     dm:sc_ dy:vn_
    ## dy              -0.037                     
    ## dm:soc_pleasant -0.974  0.013              
    ## dy:eventpl_w    -0.003  0.135  0.003       
    ## dy:soc_pleasant  0.017 -0.752 -0.018 -0.190
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -6.3306220 -0.4537026  0.1642129  0.6368689  3.4849537 
    ## 
    ## Number of Observations: 16765
    ## Number of Groups: 328

`dm` - intercept when $m$ is the outcome `dy` - intercept when $y$ is
the outcome `dm:soc_pleasant` - effect of $x$ when $m$ is the outcome
(i.e., 𝑎 path), 𝑎𝑗 dm:fwkdis_cw or SyM - effect of 𝑀 when 𝑌 is the
outcome (i.e., 𝑏 path), 𝑏𝑗 dm:fwkstrs_cw or SyX - effect of 𝑋 when 𝑌 is
the outcome (i.e., direct effect), 𝑐′𝑗 dm:timec or Sm:timec - effect of
covariate (timec) on 𝑀 dy:timec or Sy:timec - effect of covariate
(timec) on 𝑌

# Lagged analysis

``` r
# create lagged pa 
data <- data %>%
  arrange(id, obs) %>%                
  group_by(id) %>%     
  mutate(pa_l1 = lag(pa, n = 1)) %>% 
  mutate(pa_l1 = if_else(beep == 1, NA, pa_l1)) %>%
  ungroup()

# fit model with lagged eventpl
m9 <- lme(pa ~ eventpl_w_l1 + pa_l1, 
          random = ~eventpl_w_l1 + pa_l1|id,
          data = data, 
          na.action = na.omit)

summary(m9)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   30295.19 30368.06 -15137.59
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w_l1 + pa_l1 | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##              StdDev     Corr         
    ## (Intercept)  0.97413810 (Intr) evn__1
    ## eventpl_w_l1 0.05852813  0.05        
    ## pa_l1        0.17107652 -0.80  -0.24 
    ## Residual     0.93143182              
    ## 
    ## Fixed effects:  pa ~ eventpl_w_l1 + pa_l1 
    ##                  Value  Std.Error    DF  t-value p-value
    ## (Intercept)  2.9422714 0.07340958 10471 40.08021  0.0000
    ## eventpl_w_l1 0.0064967 0.00712790 10471  0.91144  0.3621
    ## pa_l1        0.3574549 0.01408036 10471 25.38677  0.0000
    ##  Correlation: 
    ##              (Intr) evn__1
    ## eventpl_w_l1  0.171       
    ## pa_l1        -0.883 -0.250
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -5.9819898 -0.4828659  0.1012140  0.5648075  4.0699712 
    ## 
    ## Number of Observations: 10801
    ## Number of Groups: 328

# VAR model

<figure>
<img src="https://lennartseizer.github.io/ild/4/4_files/figure-gfm/var.png">
</figure>

**Prepare variables**

``` r
# pa
data$pa_b <- ave(data$pa, data$id, FUN=function(x)mean(x, na.rm = TRUE)) 
data$pa_w <- data$pa - data$pa_b 
data <- data %>%
  arrange(id, obs) %>%                
  group_by(id) %>%     
  mutate(pa_w_l1 = lag(pa_w, n = 1)) %>% 
  mutate(pa_w_l1 = if_else(beep == 1, NA, pa_w_l1)) %>%
  ungroup()

# na
data$na_b <- ave(data$na, data$id, FUN=function(x)mean(x, na.rm = TRUE)) 
data$na_w <- data$na - data$na_b 
data <- data %>%
  arrange(id, obs) %>%                
  group_by(id) %>%     
  mutate(na_w_l1 = lag(na_w, n = 1)) %>% 
  mutate(na_w_l1 = if_else(beep == 1, NA, na_w_l1)) %>%
  ungroup()
```

**VAR part 1**

``` r
# b11, b21, sigma11
var1 <- lme(pa ~ pa_w_l1 + na_w_l1,
            random = ~pa_w_l1 + na_w_l1|id,
            data = data,
            na.action = na.exclude)

summary(var1)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   31664.46 31737.75 -15822.23
    ## 
    ## Random effects:
    ##  Formula: ~pa_w_l1 + na_w_l1 | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr         
    ## (Intercept) 0.9638735 (Intr) p_w_l1
    ## pa_w_l1     0.1772111 -0.231       
    ## na_w_l1     0.2360910 -0.163  0.378
    ## Residual    0.9222387              
    ## 
    ## Fixed effects:  pa ~ pa_w_l1 + na_w_l1 
    ##                 Value  Std.Error    DF  t-value p-value
    ## (Intercept)  4.570179 0.05401997 10926 84.60166   0e+00
    ## pa_w_l1      0.259849 0.01580740 10926 16.43845   0e+00
    ## na_w_l1     -0.085899 0.02438600 10926 -3.52248   4e-04
    ##  Correlation: 
    ##         (Intr) p_w_l1
    ## pa_w_l1 -0.142       
    ## na_w_l1 -0.087  0.480
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -6.0330830 -0.4824946  0.1025912  0.5624986  4.2131815 
    ## 
    ## Number of Observations: 11256
    ## Number of Groups: 328

**VAR part 2**

``` r
# b21, b22, sigma22
var2 <- lme(na ~ pa_w_l1 + na_w_l1,
            random = ~pa_w_l1 + na_w_l1|id,
            data = data,
            na.action = na.exclude)

summary(var2)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   21171.13 21244.38 -10575.56
    ## 
    ## Random effects:
    ##  Formula: ~pa_w_l1 + na_w_l1 | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev     Corr         
    ## (Intercept) 0.72152702 (Intr) p_w_l1
    ## pa_w_l1     0.08025358 -0.598       
    ## na_w_l1     0.22044728  0.022  0.383
    ## Residual    0.57781200              
    ## 
    ## Fixed effects:  na ~ pa_w_l1 + na_w_l1 
    ##                  Value  Std.Error    DF  t-value p-value
    ## (Intercept)  1.7129088 0.04026304 10883 42.54296   0e+00
    ## pa_w_l1     -0.0337596 0.00871813 10883 -3.87234   1e-04
    ## na_w_l1      0.2819012 0.01861068 10883 15.14728   0e+00
    ##  Correlation: 
    ##         (Intr) p_w_l1
    ## pa_w_l1 -0.302       
    ## na_w_l1  0.014  0.469
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -5.4142378 -0.4124302 -0.1227373  0.2485784  6.7165960 
    ## 
    ## Number of Observations: 11213
    ## Number of Groups: 328

**VAR part 3**

``` r
# sigma 12
cov(residuals(var1), residuals(var2), use = "complete.obs")
```

    ## [1] -0.2927746

# Model diagnostics

**Fit model**

``` r
m3 <- lme(pa ~ eventpl_w, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.omit)
```

**L1 residuals**

``` r
# prepare residuals/predictions
res  <- residuals(m3, type = "normalized")
pred <- fitted(m3)
df   <- data.frame(res = as.numeric(res), pred = as.numeric(pred))

# density of residuals
p_dens <- ggplot(df, aes(x = res)) + geom_density() +
  labs(title = "Distribution of Level-1 residuals", x = "Residual", y = "Density") +
  theme_bw()

# q-q plot
p_qq <- ggplot(df, aes(sample = res)) + stat_qq() + stat_qq_line() +
  labs(title = "Q-Q Plot of Level-1 residuals", x = "Theoretical quantiles", y = "Sample quantiles") +
  theme_bw()

# predicted vs residuals
p_scatter <- ggplot(df, aes(x = pred, y = res)) + geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 0.6) +
  labs(title = "Predicted vs Residuals", x = "Predicted", y = "Residuals") +
  theme_bw()

# ACF of residuals 
acf_obj <- acf(df$res, plot = FALSE, na.action = na.pass)
n_used <- acf_obj$n.used
ci <- qnorm(0.975) / sqrt(n_used)

acf_df <- data.frame(
  lag = as.numeric(acf_obj$lag) * n_used,
  acf = as.numeric(acf_obj$acf)
) %>% filter(lag > 0)

p_acf <- ggplot(acf_df, aes(x = lag, y = acf)) +
  geom_hline(yintercept = 0, linetype = "solid") +
  geom_hline(yintercept = c(-ci, ci), linetype = "dashed") +
  geom_segment(aes(xend = lag, y = 0, yend = acf)) +
  labs(title = "ACF of Level-1 residuals", x = "Lag", y = "ACF") +
  theme_bw() + ylim(c(-.1,.25))

plot_grid(p_dens, p_qq, p_scatter, p_acf)
```

![](4_files/figure-gfm/unnamed-chunk-33-1.png)<!-- -->

**Fit model with AR errors**

``` r
m3_ar <- lme(pa ~ eventpl_w, 
             random = ~eventpl_w|id,
             data = data, 
             na.action = na.omit,
             correlation = corAR1(form = ~beep|id/day))
```

**L1 residuals**

``` r
# prepare residuals/predictions
res  <- residuals(m3_ar, type = "normalized")
pred <- fitted(m3_ar)
df   <- data.frame(res = as.numeric(res), pred = as.numeric(pred))

# density of residuals
p_dens <- ggplot(df, aes(x = res)) + geom_density() +
  labs(title = "Distribution of Level-1 residuals", x = "Residual", 
       y = "Density") + theme_bw()

# q-q plot
p_qq <- ggplot(df, aes(sample = res)) + stat_qq() + stat_qq_line() +
  labs(title = "Q-Q Plot of Level-1 residuals", x = "Theoretical quantiles", 
       y = "Sample quantiles") + theme_bw()

# predicted vs residuals
p_scatter <- ggplot(df, aes(x = pred, y = res)) + geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 0.6) +
  labs(title = "Predicted vs Residuals", x = "Predicted", y = "Residuals") +
  theme_bw()

# ACF of residuals 
acf_obj <- acf(df$res, plot = FALSE, na.action = na.pass)
n_used <- acf_obj$n.used
ci <- qnorm(0.975) / sqrt(n_used)

acf_df <- data.frame(
  lag = as.numeric(acf_obj$lag) * n_used,
  acf = as.numeric(acf_obj$acf)
) %>% filter(lag > 0)

p_acf <- ggplot(acf_df, aes(x = lag, y = acf)) +
  geom_hline(yintercept = 0, linetype = "solid") +
  geom_hline(yintercept = c(-ci, ci), linetype = "dashed") +
  geom_segment(aes(xend = lag, y = 0, yend = acf)) +
  labs(title = "ACF of Level-1 residuals", x = "Lag", y = "ACF") +
  theme_bw() + ylim(c(-.1,.25))

# plot
plot_grid(p_dens, p_qq, p_scatter, p_acf)
```

![](4_files/figure-gfm/unnamed-chunk-35-1.png)<!-- -->

**L2 residuals**

``` r
# extract random effects 
re_int <- as.numeric(ranef(m3_ar)[,"(Intercept)"]) # level-2 intercepts
re_slope <- as.numeric(ranef(m3_ar)[,"eventpl_w"]) # level-2 slopes 

df_int <- data.frame(effect = re_int)
df_slope <- data.frame(effect = re_slope)

# intercept residuals
p_int_dens <- ggplot(df_int, aes(x = effect)) + geom_density() +
  labs(title = "Distribution of intercept residuals", x = "Intercept BLUP", 
       y = "Density") + theme_bw()

p_int_qq <- ggplot(df_int, aes(sample = effect)) + stat_qq() + stat_qq_line() +
  labs(title = "Q–Q Plot of intercept residuals", x = "Theoretical quantiles", 
       y = "Sample quantiles") + theme_bw()

# slope residuals
p_slope_dens <- ggplot(df_slope, aes(x = effect)) + geom_density() +
  labs(title = "Distribution of slope residuals", x = "eventpl_w slope BLUP", 
       y = "Density") + theme_bw()

p_slope_qq <- ggplot(df_slope, aes(sample = effect)) + stat_qq() + stat_qq_line() +
  labs(title = "Q–Q Plot of slope residuals", x = "Theoretical quantiles", 
       y = "Sample quantiles") + theme_bw()

# plot
plot_grid(p_int_dens, p_int_qq, p_slope_dens, p_slope_qq)
```

![](4_files/figure-gfm/unnamed-chunk-36-1.png)<!-- -->

``` r
install.packages("HLMdiag")
```

    ## Installing package into '/home/runner/work/_temp/Library'
    ## (as 'lib' is unspecified)

    ## also installing the dependencies 'timechange', 'hms', 'lubridate', 'snakecase', 'janitor', 'ggrepel', 'diagonals', 'RcppArmadillo'

``` r
library(HLMdiag)
```

    ## 
    ## Attaching package: 'HLMdiag'

    ## The following object is masked from 'package:stats':
    ## 
    ##     covratio

``` r
m3_infl <- hlm_influence(m3, level = "id")
```

    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB
    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB
    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB
    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB
    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB
    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB
    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB
    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB
    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB
    ## Warning in asMethod(object): sparse->dense coercion: allocating vector of size
    ## 1.5 GiB

``` r
dotplot_diag(m3_infl$cooksd, name = "cooks.distance", cutoff = 4/328)
```

![](4_files/figure-gfm/unnamed-chunk-37-1.png)<!-- -->

# Standardized / additional outputs

**Confidence intervals**

``` r
# confidence intervals
intervals(m3, level = .95)
```

    ## Approximate 95% confidence intervals
    ## 
    ##  Fixed effects:
    ##                 lower     est.     upper
    ## (Intercept) 4.4489786 4.553894 4.6588090
    ## eventpl_w   0.1736067 0.189554 0.2055012
    ## 
    ##  Random Effects:
    ##   Level: id 
    ##                                  lower       est.      upper
    ## sd((Intercept))             0.88548275  0.9573536  1.0350580
    ## sd(eventpl_w)               0.09174146  0.1056453  0.1216563
    ## cor((Intercept),eventpl_w) -0.46309486 -0.3266790 -0.1751435
    ## 
    ##  Within-group standard error:
    ##     lower      est.     upper 
    ## 0.9324045 0.9436220 0.9549743

**Standardized coefficients**

``` r
library(parameters)
standardize_parameters(m3)
```

    ## # Standardization method: refit
    ## 
    ## Parameter   | Std. Coef. |        95% CI
    ## ----------------------------------------
    ## (Intercept) |  -2.40e-03 | [-0.08, 0.07]
    ## eventpl w   |       0.21 | [ 0.20, 0.23]

**Cohen’s d** Framework: <https://doi.org/10.1037/a0014699>,
<https://doi.org/10.1037/a0030048>  
Detailed tutorial:
<https://solomonkurz.netlify.app/blog/2021-04-22-effect-sizes-for-experimental-trials-analyzed-with-multilevel-growth-models-two-of-two/>

$$
d_{GMA} = \frac{b_{int}*time}{SD_{pooled}}
\ \ \ \ 
SD_{pooled} = \sqrt{\frac{SD^2_{c0}+SD^2_{t0}}{2}}
$$

``` r
# fit model
m10 <- lme(pa ~ day * status, 
           random = ~day|id,
           data = data[!data$status == "depressed",], 
           na.action = na.omit)

summary(m10)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data[!data$status == "depressed", ] 
    ##        AIC      BIC    logLik
    ##   25996.32 26053.71 -12990.16
    ## 
    ## Random effects:
    ##  Formula: ~day | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9231431 (Intr)
    ## day         0.1418058 -0.329
    ## Residual    0.8756421       
    ## 
    ## Fixed effects:  pa ~ day * status 
    ##                         Value  Std.Error   DF  t-value p-value
    ## (Intercept)          5.156396 0.09159298 9429 56.29685  0.0000
    ## day                  0.008130 0.01528720 9429  0.53182  0.5949
    ## statuspsychotic     -0.730330 0.13155479  217 -5.55153  0.0000
    ## day:statuspsychotic -0.028749 0.02209541 9429 -1.30113  0.1932
    ##  Correlation: 
    ##                     (Intr) day    sttsps
    ## day                 -0.406              
    ## statuspsychotic     -0.696  0.283       
    ## day:statuspsychotic  0.281 -0.692 -0.411
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -6.2089455 -0.4454171  0.1055160  0.5416973  4.4546423 
    ## 
    ## Number of Observations: 9650
    ## Number of Groups: 219

``` r
# psychotic sd_d1
sd_d1_p <- sd(data$pa[data$status=="psychotic" & data$day==1], na.rm = T)

# control sd_d1
sd_d1_c <- sd(data$pa[data$status=="control" & data$day==1], na.rm = T)

# pooled sd
pooled_sd <- sqrt((sd_d1_p^2 + sd_d1_c^2) / 2)

# d_gma
as.numeric(fixef(m10)["day:statuspsychotic"]) *5 / pooled_sd
```

    ## [1] -0.1136561

# Example write-up

``` r
install.packages("sjPlot")
```

    ## Installing package into '/home/runner/work/_temp/Library'
    ## (as 'lib' is unspecified)

    ## also installing the dependencies 'effectsize', 'ggeffects', 'sjlabelled', 'sjmisc', 'sjstats'

``` r
library(sjPlot)
```

    ## 
    ## Attaching package: 'sjPlot'

    ## The following objects are masked from 'package:cowplot':
    ## 
    ##     plot_grid, save_plot

    ## The following object is masked from 'package:ggplot2':
    ## 
    ##     set_theme

``` r
tab_model(m1 ,m3, m4)
```

<table style="border-collapse:collapse; border:none;">
<tr>
<th style="border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm;  text-align:left; ">
 
</th>
<th colspan="3" style="border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm; ">
pa
</th>
<th colspan="3" style="border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm; ">
pa
</th>
<th colspan="3" style="border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm; ">
pa
</th>
</tr>
<tr>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  text-align:left; ">
Predictors
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
Estimates
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
CI
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
p
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
Estimates
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
CI
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  col7">
p
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  col8">
Estimates
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  col9">
CI
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  0">
p
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
(Intercept)
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
4.55
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
4.44 – 4.65
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
<strong>\<0.001</strong>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
4.55
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
4.45 – 4.66
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col7">
<strong>\<0.001</strong>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col8">
4.82
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col9">
4.50 – 5.14
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  0">
<strong>\<0.001</strong>
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
eventpl w
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.19
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.17 – 0.21
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col7">
<strong>\<0.001</strong>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col8">
0.19
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col9">
0.18 – 0.21
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  0">
<strong>\<0.001</strong>
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
eventpl bc
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col7">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col8">
0.63
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col9">
0.50 – 0.76
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  0">
<strong>\<0.001</strong>
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
age
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col7">
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col8">
-0.01
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  col9">
-0.02 – 0.00
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  0">
0.084
</td>
</tr>
<tr>
<td colspan="10" style="font-weight:bold; text-align:left; padding-top:.8em;">
Random Effects
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
σ<sup>2</sup>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
1.01
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.89
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.89
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
τ<sub>00</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.92 <sub>id</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.92 <sub>id</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.70 <sub>id</sub>
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
τ<sub>11</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
 
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.01 <sub>id.eventpl_w</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.01 <sub>id.eventpl_w</sub>
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
ρ<sub>01</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
 
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
-0.33 <sub>id</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
-0.31 <sub>id</sub>
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
ICC
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.48
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.51
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.45
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
N
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
328 <sub>id</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
328 <sub>id</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
328 <sub>id</sub>
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm; border-top:1px solid;">
Observations
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left; border-top:1px solid;" colspan="3">
14792
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left; border-top:1px solid;" colspan="3">
14039
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left; border-top:1px solid;" colspan="3">
14039
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
Marginal R<sup>2</sup> / Conditional R<sup>2</sup>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.000 / 0.477
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.046 / 0.537
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.148 / 0.532
</td>
</tr>
</table>

# Exercises

1.  1)  Estimate a model that predicts negative affect (`na`) based on
        whether participants are alone or with others `soc_alone`. (b)
        Test whether the previous effect is moderated by how pleasant
        the company of others is experienced `soc_pleasant`. Pick an
        appropriate random effects structure and check model
        assumptions.
2.  1)  Estimate the time trend of negative affect (`na`) over the study
        period, and (b) whether this time trend differs between mental
        health status groups (`status`). Report standardized effect
        sizes for the time:group interactions.
