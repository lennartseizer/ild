Fitting mixed-effects models
================

``` r
install.packages("lme4")
```

    ## Installing package into '/home/runner/work/_temp/Library'
    ## (as 'lib' is unspecified)

``` r
install.packages("nlme")
```

    ## Installing package into '/home/runner/work/_temp/Library'
    ## (as 'lib' is unspecified)

``` r
install.packages("scales")
```

    ## Installing package into '/home/runner/work/_temp/Library'
    ## (as 'lib' is unspecified)

``` r
install.packages("ggplot2")
```

    ## Installing package into '/home/runner/work/_temp/Library'
    ## (as 'lib' is unspecified)

``` r
install.packages("cowplot")
```

    ## Installing package into '/home/runner/work/_temp/Library'
    ## (as 'lib' is unspecified)

``` r
install.packages("dplyr")
```

    ## Installing package into '/home/runner/work/_temp/Library'
    ## (as 'lib' is unspecified)

| Feature / Task                 | **lme4 (lmer)**                          | **nlme (lme)**                           |
|--------------------------------|------------------------------------------|------------------------------------------|
| Main function                  | `lmer()`                                 | `lme()`                                  |
| Syntax for random intercepts   | `lmer(y ~ 1 + (1|id), data = df)`        | `lme(y ~ 1, random = ~1|id, data = df)`  |
| Random slopes                  | `lmer(y ~ x + (x|id), data = df)`        | `lme(y ~ x, random = ~x|id, data = df)`  |
| Multiple grouping factors      | Yes (nested/crossed)                     | Limited, mostly nested                   |
| Estimation method              | REML / ML (fast, sparse matrices)        | REML / ML (older implementation)         |
| Handles heteroscedasticity     | Not directly                             | Yes, via `weights = varIdent(...)`       |
| Correlation structures         | Not directly                             | Yes, via `corAR1`, `corCompSymm`, etc.   |
| Extract fixed effects          | `fixef(model)`                           | `fixef(model)`                           |
| Extract random effects (BLUPs) | `ranef(model)`                           | `ranef(model)`                           |
| Fitted values                  | `fitted(model)`                          | `fitted(model)`                          |
| P-values for fixed effects     | Not provided by default (use `lmerTest`) | Provided directly in summary output      |
| Popular extensions             | `lmerTest`, `glmer`, `glmmTMB`           | `gnls`, `gls`                            |
| Speed / scalability            | Very fast, good for large data           | Slower, better for smaller/moderate data |

# Null model

``` r
# set environment
library(nlme)
library(lme4)
library(ggplot2)
library(cowplot)
library(scales)
```

``` r
# fit base model
m1 <- lme(pa ~ 1, 
          random = ~1|id,
          data = data, 
          na.action = na.exclude)

summary(m1)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   43350.01 43372.82 -21672.01
    ## 
    ## Random effects:
    ##  Formula: ~1 | id
    ##         (Intercept) Residual
    ## StdDev:   0.9597608 1.004858
    ## 
    ## Fixed effects:  pa ~ 1 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.549196 0.05366659 14464 84.76775       0
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -5.2911753 -0.5171447  0.1007566  0.5907290  4.2945047 
    ## 
    ## Number of Observations: 14792
    ## Number of Groups: 328

``` r
# fixed effects
fixef(m1)
```

    ## (Intercept) 
    ##    4.549196

``` r
# random effects
head(ranef(m1))
```

    ##      (Intercept)
    ## c100   0.5557835
    ## c101   0.1352157
    ## c102  -0.3672321
    ## c103   2.1116416
    ## c104   1.8477497
    ## c105   1.5633701

``` r
# plot individual intercepts and residuals
hist1 <- ggplot(data.frame(value = coef(m1)[[1]]), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, color = "white") +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(x = "Average Positive Affect", y = "Density") +
  theme_bw()

hist2 <- ggplot(data.frame(value = resid(m1)), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, color = "white") +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(x = "Residual", y = "Density") +
  theme_bw()
  
plot_grid(hist1, hist2)
```

![](4_files/figure-gfm/unnamed-chunk-5-1.png)<!-- -->

**Shrinkage**: compare pooled estimates with non-pooled means

``` r
# compute individual means
indiv_means <- data %>%
  group_by(id) %>%
  summarise(indiv_mean = mean(pa, na.rm = TRUE)) %>%
  ungroup()

# plot pooled vs non-pooled means
hist1 <- ggplot(data.frame(value = coef(m1)[[1]]), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, color = "white") +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(title = "Average Positive Affect", x = "BLUPs") +
  theme_bw()

hist2 <- ggplot(data.frame(value = indiv_means$indiv_mean), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, color = "white") +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(title = "Average Positive Affect", x = "Observed means") +
  theme_bw()
  
plot_grid(hist1, hist2)
```

![](4_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->

``` r
# pooled vs non-pooled means
head(data.frame(BLUP = coef(m1)[[1]], 
                Obs_Means = indiv_means$indiv_mean))
```

    ##       BLUP Obs_Means
    ## 1 5.104980  5.118519
    ## 2 4.684412  4.687500
    ## 3 4.181964  4.175141
    ## 4 6.660838  6.703704
    ## 5 6.396946  6.435897
    ## 6 6.112566  6.151515

**ICC**: Intraclass Correlation Coefficient

``` r
int_var <- getVarCov(m1)[1,1] # random intercept variance
res_var <- sigma(m1)^2 # residual variance

int_var / (int_var + res_var)
```

    ## [1] 0.4770572

# Adding time as a predictor

``` r
# plot time variables
d <- data %>% filter(id == "c100") %>% mutate(idx = row_number())

t1 <- ggplot(d, aes(idx, obs)) + geom_line() + geom_point() + 
  labs(x="Index", y="obs") + theme_bw()
t2 <- ggplot(d, aes(idx, day)) + geom_line() + geom_point() + 
  labs(x="Index", y="day") + theme_bw()
t3 <- ggplot(d, aes(idx, beep)) + geom_line() + geom_point() + 
  labs(x="Index", y="beep")     + theme_bw()
t4 <- ggplot(d, aes(idx, beeptime)) + geom_line() + geom_point() + 
  labs(x="Index", y="beeptime") + theme_bw()

plot_grid(t1, t2, t3, t4)
```

![](4_files/figure-gfm/unnamed-chunk-8-1.png)<!-- -->

**Variance decomposition based on time variables**

``` r
# intercept-only model with time-variance components 
m2_lme <- lme(pa ~ 1, 
              random = ~1|id/day/beeptime,
              data = data, 
              na.action = na.omit)

m2_lmer <- lmer(pa ~ 1 + (1|id) + (1|day) + (1 | beeptime) + (1|id:day) +
                  (1|id:beeptime) + (1|day:beeptime),
                data = data)

# model summaries
summary(m2_lme)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   42294.84 42332.85 -21142.42
    ## 
    ## Random effects:
    ##  Formula: ~1 | id
    ##         (Intercept)
    ## StdDev:    0.943853
    ## 
    ##  Formula: ~1 | day %in% id
    ##         (Intercept)
    ## StdDev:   0.4587877
    ## 
    ##  Formula: ~1 | beeptime %in% day %in% id
    ##         (Intercept)  Residual
    ## StdDev:   0.8407292 0.3576609
    ## 
    ## Fixed effects:  pa ~ 1 
    ##                Value  Std.Error    DF t-value p-value
    ## (Intercept) 4.550016 0.05373061 12850  84.682       0
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -2.18303557 -0.18747563  0.03813596  0.21591511  1.53929769 
    ## 
    ## Number of Observations: 14792
    ## Number of Groups: 
    ##                        id               day %in% id beeptime %in% day %in% id 
    ##                       328                      1942                     14792

``` r
summary(m2_lmer)
```

    ## Linear mixed model fit by REML ['lmerMod']
    ## Formula: pa ~ 1 + (1 | id) + (1 | day) + (1 | beeptime) + (1 | id:day) +  
    ##     (1 | id:beeptime) + (1 | day:beeptime)
    ##    Data: data
    ## 
    ## REML criterion at convergence: 42267.9
    ## 
    ## Scaled residuals: 
    ##     Min      1Q  Median      3Q     Max 
    ## -5.4359 -0.4671  0.0930  0.5357  3.7972 
    ## 
    ## Random effects:
    ##  Groups       Name        Variance  Std.Dev. 
    ##  id:beeptime  (Intercept) 4.835e-02 2.199e-01
    ##  id:day       (Intercept) 2.107e-01 4.590e-01
    ##  day:beeptime (Intercept) 1.820e-09 4.266e-05
    ##  id           (Intercept) 8.911e-01 9.440e-01
    ##  beeptime     (Intercept) 6.152e-03 7.843e-02
    ##  day          (Intercept) 1.863e-09 4.316e-05
    ##  Residual                 7.806e-01 8.835e-01
    ## Number of obs: 14792, groups:  
    ## id:beeptime, 14316; id:day, 1942; day:beeptime, 1384; id, 328; beeptime, 282; day, 6
    ## 
    ## Fixed effects:
    ##             Estimate Std. Error t value
    ## (Intercept)  4.54689    0.05406    84.1
    ## optimizer (nloptwrap) convergence code: 0 (OK)
    ## boundary (singular) fit: see help('isSingular')

``` r
# extract variance components
vc <- as.data.frame(VarCorr(m2_lmer)) %>%
  group_by(grp) %>%
  summarise(vcov = sum(vcov), .groups = "drop") %>%
  mutate(Prop = vcov / sum(vcov)) %>%
  arrange(Prop)

# clearer plot: sorted horizontal bars with percent labels
ggplot(vc, aes(x = Prop, y = reorder(grp, Prop), fill = grp)) +
  geom_col(width = 0.7, color = "white", show.legend = FALSE) +
  geom_text(aes(label = percent(Prop, accuracy = 0.1)),
            hjust = -0.1, size = 3.2) +
  scale_x_continuous(labels = percent_format(accuracy = 1),
                     expand = expansion(mult = c(0, 0.1))) +
  labs(title = "Variance decomposition for PA",
       x = "Proportion of variance", y = NULL) +
  theme_bw(base_size = 12) 
```

![](4_files/figure-gfm/unnamed-chunk-9-1.png)<!-- -->

# Adding a L1 predictor

``` r
# fit model with predictor
m3 <- lme(pa ~ eventpl_w, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.omit)

summary(m3)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39707.38 39752.68 -19847.69
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9573536 (Intr)
    ## eventpl_w   0.1056453 -0.327
    ## Residual    0.9436220       
    ## 
    ## Fixed effects:  pa ~ eventpl_w 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.553894 0.05352444 13710 85.08065       0
    ## eventpl_w   0.189554 0.00813576 13710 23.29885       0
    ##  Correlation: 
    ##           (Intr)
    ## eventpl_w -0.232
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.78952092 -0.50284000  0.09444534  0.59143420  4.38937466 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

``` r
# fixed effects
fixef(m3)
```

    ## (Intercept)   eventpl_w 
    ##    4.553894    0.189554

``` r
# random effects
head(ranef(m3))
```

    ##      (Intercept)   eventpl_w
    ## c100   0.5731350 -0.03132804
    ## c101   0.1362071 -0.08478598
    ## c102  -0.3696322  0.02588976
    ## c103   2.1087963 -0.03187367
    ## c104   1.7994943 -0.07237153
    ## c105   1.5605030  0.01566165

``` r
# plot estimates
hist(coef(m3)[[1]], breaks = 30, freq=FALSE, main="", 
     xlab="Intercepts")
```

![](4_files/figure-gfm/unnamed-chunk-12-1.png)<!-- -->

``` r
hist(coef(m3)[[2]], breaks = 30, freq=FALSE, main="", 
     xlab="Slopes")
```

![](4_files/figure-gfm/unnamed-chunk-12-2.png)<!-- -->

``` r
hist(resid(m3), breaks = 30, freq=FALSE, main="", 
     xlab="Residuals")
```

![](4_files/figure-gfm/unnamed-chunk-12-3.png)<!-- -->

``` r
plot(coef(m3)[[1]], coef(m3)[[2]], xlab="Intercept", ylab="Slope")
abline(v=fixef(m3)[1], lty="dotted")
abline(h=fixef(m3)[2], lty="dotted")
```

![](4_files/figure-gfm/unnamed-chunk-12-4.png)<!-- -->

# Adding covariates

**L2 covariate**

``` r
# fit model with L2 covariate
m4 <- lme(pa ~ eventpl_w + age, 
          random = ~eventpl|id,
          data = data, 
          na.action = na.omit)

summary(m4)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC     BIC    logLik
    ##   39716.96 39769.8 -19851.48
    ## 
    ## Random effects:
    ##  Formula: ~eventpl | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 1.0039352 (Intr)
    ## eventpl     0.1056145 -0.419
    ## Residual    0.9435977       
    ## 
    ## Fixed effects:  pa ~ eventpl_w + age 
    ##                 Value  Std.Error    DF  t-value p-value
    ## (Intercept)  4.802857 0.18319523 13710 26.21715  0.0000
    ## eventpl_w    0.186406 0.00811938 13710 22.95810  0.0000
    ## age         -0.006308 0.00480207   326 -1.31350  0.1899
    ##  Correlation: 
    ##           (Intr) evntp_
    ## eventpl_w -0.052       
    ## age       -0.957 -0.010
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.79413825 -0.50379540  0.09328878  0.59223959  4.41479818 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

``` r
# fixed effects
fixef(m4)
```

    ##  (Intercept)    eventpl_w          age 
    ##  4.802857450  0.186405554 -0.006307518

``` r
# random effects
head(ranef(m4))
```

    ##      (Intercept)      eventpl
    ## c100   0.5714485 -0.024014338
    ## c101   0.2196918 -0.083627989
    ## c102  -0.4583079  0.026348160
    ## c103   2.1368216  0.006035142
    ## c104   1.8224674 -0.068304988
    ## c105   1.4811645  0.027026784

``` r
# grand-mean center age
data$age_c <- data$age - mean(aggregate(data, age ~ id, unique)$age)

# fit model with L2 covariate
m4_c <- lme(pa ~ eventpl_w + age_c, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.omit)

summary(m4_c)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39716.69 39769.53 -19851.34
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9545437 (Intr)
    ## eventpl_w   0.1056158 -0.314
    ## Residual    0.9436230       
    ## 
    ## Fixed effects:  pa ~ eventpl_w + age_c 
    ##                 Value  Std.Error    DF  t-value p-value
    ## (Intercept)  4.554096 0.05337145 13710 85.32832  0.0000
    ## eventpl_w    0.189769 0.00813736 13710 23.32077  0.0000
    ## age_c       -0.006001 0.00479366   326 -1.25185  0.2115
    ##  Correlation: 
    ##           (Intr) evntp_
    ## eventpl_w -0.223       
    ## age_c     -0.003 -0.014
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.79361249 -0.50371070  0.09541178  0.59181378  4.38711857 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

**L1 covariate**

``` r
# fit model with L1 covariate
m5 <- lme(pa ~ eventpl + use_alcohol, 
          random = ~eventpl + use_alcohol|id,
          data = data, 
          na.action = na.omit)

summary(m5)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39091.98 39167.33 -19535.99
    ## 
    ## Random effects:
    ##  Formula: ~eventpl + use_alcohol | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr         
    ## (Intercept) 0.9520985 (Intr) evntpl
    ## eventpl     0.1030892 -0.434       
    ## use_alcohol 0.2763784 -0.162  0.469
    ## Residual    0.9413096              
    ## 
    ## Fixed effects:  pa ~ eventpl + use_alcohol 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.286102 0.05403063 13505 79.32727       0
    ## eventpl     0.190923 0.00806320 13505 23.67831       0
    ## use_alcohol 0.221930 0.04236285 13505  5.23878       0
    ##  Correlation: 
    ##             (Intr) evntpl
    ## eventpl     -0.408       
    ## use_alcohol -0.087  0.093
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.80222077 -0.50241687  0.09403438  0.58528803  4.12269711 
    ## 
    ## Number of Observations: 13835
    ## Number of Groups: 328

Card: Fixed vs random effects There is not yet consensus about how to
deal with singularity, or more generally to choose which random-effects
specification (from a range of choices of varying complexity) to use.
Some proposals include:

- avoid fitting overly complex models in the first place, i.e. design
  experiments/restrict models a priori such that the variance-covariance
  matrices can be estimated precisely enough to avoid singularity
  (Matuschek et al 2017)

- use some form of model selection to choose a model that balances
  predictive accuracy and overfitting/type I error (Bates et al 2015,
  Matuschek et al 2017)

- “keep it maximal”, i.e. fit the most complex model consistent with the
  experimental design, removing only terms required to allow a
  non-singular fit (Barr et al. 2013), or removing further terms based
  on p-values or AIC

``` r
# example RQ: PA <- eventpl within-participants
# covariates: use_alcohol, use_coffee

# base model
m6 <- lme(pa ~ eventpl_b + use_alcohol + use_coffee, 
          random = ~1|id,
          data = data, 
          na.action = na.omit)

# random effect for use_alcohol
m7 <- lme(pa ~ eventpl_b + use_alcohol + use_coffee, 
          random = ~use_alcohol|id,
          data = data, 
          na.action = na.omit)

anova(m6, m7)
```

    ##    Model df      AIC      BIC    logLik   Test  L.Ratio p-value
    ## m6     1  6 42489.69 42535.19 -21238.84                        
    ## m7     2  8 42474.28 42534.94 -21229.14 1 vs 2 19.40884   1e-04

``` r
# random effect for use_coffee
m8 <- lme(pa ~ eventpl_b + use_alcohol + use_coffee, 
          random = ~use_coffee|id,
          data = data, 
          na.action = na.omit)

anova(m6, m8)
```

    ##    Model df      AIC      BIC    logLik   Test  L.Ratio p-value
    ## m6     1  6 42489.69 42535.19 -21238.84                        
    ## m8     2  8 42489.32 42549.99 -21236.66 1 vs 2 4.367015  0.1126

``` r
# final model
m8 <- lme(pa ~ eventpl_w + eventpl_b + use_alcohol + use_coffee, 
          random = ~eventpl_w + use_alcohol|id,
          data = data, 
          na.action = na.omit)

summary(m8)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC   logLik
    ##   39060.39 39150.81 -19518.2
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w + use_alcohol | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr         
    ## (Intercept) 0.8437221 (Intr) evntp_
    ## eventpl_w   0.1031559 -0.321       
    ## use_alcohol 0.2740129 -0.115  0.466
    ## Residual    0.9413226              
    ## 
    ## Fixed effects:  pa ~ eventpl_w + eventpl_b + use_alcohol + use_coffee 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 3.682234 0.10126114 13504 36.36375  0.0000
    ## eventpl_w   0.189385 0.00806775 13504 23.47430  0.0000
    ## eventpl_b   0.620475 0.06547176   326  9.47699  0.0000
    ## use_alcohol 0.229839 0.04242565 13504  5.41745  0.0000
    ## use_coffee  0.036886 0.02079589 13504  1.77373  0.0761
    ##  Correlation: 
    ##             (Intr) evntpl_w evntpl_b us_lch
    ## eventpl_w   -0.133                         
    ## eventpl_b   -0.882  0.033                  
    ## use_alcohol -0.043  0.090    0.000         
    ## use_coffee  -0.049 -0.006   -0.009    0.092
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.77079224 -0.50344815  0.09619936  0.59049495  4.12439675 
    ## 
    ## Number of Observations: 13835
    ## Number of Groups: 328

# Moderation analysis

**L1 moderation**

``` r
m9 <- lme(pa ~ eventpl * location, 
          random = ~eventpl|id,
          data = data, 
          na.action = na.omit)

summary(m9)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39688.28 39763.77 -19834.14
    ## 
    ## Random effects:
    ##  Formula: ~eventpl | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9517547 (Intr)
    ## eventpl     0.1050828 -0.434
    ## Residual    0.9435633       
    ## 
    ## Fixed effects:  pa ~ eventpl * location 
    ##                           Value Std.Error    DF   t-value p-value
    ## (Intercept)            4.576906 0.2244916 13706 20.387874  0.0000
    ## eventpl                0.105858 0.1068585 13706  0.990636  0.3219
    ## locationhome          -0.298885 0.2185937 13706 -1.367310  0.1716
    ## locationother         -0.255544 0.2188224 13706 -1.167817  0.2429
    ## eventpl:locationhome   0.089429 0.1068771 13706  0.836742  0.4028
    ## eventpl:locationother  0.085718 0.1069565 13706  0.801430  0.4229
    ##  Correlation: 
    ##                       (Intr) evntpl lctnhm lctnth evntpl:lctnh
    ## eventpl               -0.326                                  
    ## locationhome          -0.970  0.329                           
    ## locationother         -0.969  0.329  0.994                    
    ## eventpl:locationhome   0.320 -0.996 -0.331 -0.328             
    ## eventpl:locationother  0.320 -0.996 -0.328 -0.332  0.995      
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.79524756 -0.49910088  0.09110084  0.59399987  4.42091841 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

**L2 moderation**

``` r
m10 <- lme(pa ~ eventpl * status, 
          random = ~eventpl|id,
          data = data,
          na.action = na.omit)

summary(m10)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC   BIC    logLik
    ##   39567.51 39643 -19773.75
    ## 
    ## Random effects:
    ##  Formula: ~eventpl | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev     Corr  
    ## (Intercept) 0.80379682 (Intr)
    ## eventpl     0.09212228 -0.257
    ## Residual    0.94337509       
    ## 
    ## Fixed effects:  pa ~ eventpl * status 
    ##                             Value  Std.Error    DF   t-value p-value
    ## (Intercept)              4.974370 0.07897360 13708  62.98775  0.0000
    ## eventpl                  0.140546 0.01314076 13708  10.69539  0.0000
    ## statusdepressed         -1.230170 0.11173545   325 -11.00967  0.0000
    ## statuspsychotic         -0.806735 0.11319533   325  -7.12693  0.0000
    ## eventpl:statusdepressed  0.123285 0.01794763 13708   6.86913  0.0000
    ## eventpl:statuspsychotic  0.024355 0.01928090 13708   1.26315  0.2066
    ##  Correlation: 
    ##                         (Intr) evntpl sttsdp sttsps evntpl:sttsd
    ## eventpl                 -0.317                                  
    ## statusdepressed         -0.707  0.224                           
    ## statuspsychotic         -0.698  0.221  0.493                    
    ## eventpl:statusdepressed  0.232 -0.732 -0.297 -0.162             
    ## eventpl:statuspsychotic  0.216 -0.682 -0.152 -0.310  0.499      
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.79476663 -0.50341734  0.08888837  0.59009032  4.32957188 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

# Mediation analysis

Terminology:  
`1-1-1` eventpl -\> use_alcohol -\> PA `1-2-1` eventpl -\> XX -\> PA

# Lagged analyses

# Model diagnostics

``` r
# fit model
m3 <- lme(pa ~ eventpl_w, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.omit)
```

**L1 residuals**

``` r
# prepare residuals/predictions
res  <- residuals(m3, type = "normalized")
pred <- fitted(m3)
df   <- data.frame(res = as.numeric(res), pred = as.numeric(pred))

# density of residuals
p_dens <- ggplot(df, aes(x = res)) + geom_density() +
  labs(title = "Distribution of Level-1 residuals", x = "Residual", y = "Density") +
  theme_bw()

# q-q plot
p_qq <- ggplot(df, aes(sample = res)) + stat_qq() + stat_qq_line() +
  labs(title = "Q-Q Plot of Level-1 residuals", x = "Theoretical quantiles", y = "Sample quantiles") +
  theme_bw()

# predicted vs residuals
p_scatter <- ggplot(df, aes(x = pred, y = res)) + geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 0.6) +
  labs(title = "Predicted vs Residuals", x = "Predicted", y = "Residuals") +
  theme_bw()

# ACF of residuals 
acf_obj <- acf(df$res, plot = FALSE, na.action = na.pass)
n_used <- acf_obj$n.used
ci <- qnorm(0.975) / sqrt(n_used)

acf_df <- data.frame(
  lag = as.numeric(acf_obj$lag) * n_used,
  acf = as.numeric(acf_obj$acf)
) %>% filter(lag > 0)

p_acf <- ggplot(acf_df, aes(x = lag, y = acf)) +
  geom_hline(yintercept = 0, linetype = "solid") +
  geom_hline(yintercept = c(-ci, ci), linetype = "dashed") +
  geom_segment(aes(xend = lag, y = 0, yend = acf)) +
  labs(title = "ACF of Level-1 residuals", x = "Lag", y = "ACF") +
  theme_bw()

plot_grid(p_dens, p_qq, p_scatter, p_acf)
```

![](4_files/figure-gfm/unnamed-chunk-22-1.png)<!-- -->

``` r
# fit model with AR errors
m3_ar <- lme(pa ~ eventpl_w, 
             random = ~eventpl_w|id,
             data = data, 
             na.action = na.omit,
             correlation = corAR1(form = ~beep|id/day))
```

**L1 residuals**

``` r
# prepare residuals/predictions
res  <- residuals(m3_ar, type = "normalized")
pred <- fitted(m3_ar)
df   <- data.frame(res = as.numeric(res), pred = as.numeric(pred))

# density of residuals
p_dens <- ggplot(df, aes(x = res)) + geom_density() +
  labs(title = "Distribution of Level-1 residuals", x = "Residual", 
       y = "Density") + theme_bw()

# q-q plot
p_qq <- ggplot(df, aes(sample = res)) + stat_qq() + stat_qq_line() +
  labs(title = "Q-Q Plot of Level-1 residuals", x = "Theoretical quantiles", 
       y = "Sample quantiles") + theme_bw()

# predicted vs residuals
p_scatter <- ggplot(df, aes(x = pred, y = res)) + geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 0.6) +
  labs(title = "Predicted vs Residuals", x = "Predicted", y = "Residuals") +
  theme_bw()

# ACF of residuals 
acf_obj <- acf(df$res, plot = FALSE, na.action = na.pass)
n_used <- acf_obj$n.used
ci <- qnorm(0.975) / sqrt(n_used)

acf_df <- data.frame(
  lag = as.numeric(acf_obj$lag) * n_used,
  acf = as.numeric(acf_obj$acf)
) %>% filter(lag > 0)

p_acf <- ggplot(acf_df, aes(x = lag, y = acf)) +
  geom_hline(yintercept = 0, linetype = "solid") +
  geom_hline(yintercept = c(-ci, ci), linetype = "dashed") +
  geom_segment(aes(xend = lag, y = 0, yend = acf)) +
  labs(title = "ACF of Level-1 residuals", x = "Lag", y = "ACF") +
  theme_bw()

# plot
plot_grid(p_dens, p_qq, p_scatter, p_acf)
```

![](4_files/figure-gfm/unnamed-chunk-24-1.png)<!-- -->

**L2 residuals**

``` r
# extract random effects 
re_int   <- as.numeric(ranef(m3_ar)[,"(Intercept)"])  # level-2 intercepts
re_slope <- as.numeric(ranef(m3   )[,"eventpl_w"])    # level-2 slopes 

df_int   <- data.frame(effect = re_int)
df_slope <- data.frame(effect = re_slope)

# intercept residuals
p_int_dens <- ggplot(df_int, aes(x = effect)) + geom_density() +
  labs(title = "Distribution of intercept residuals", x = "Intercept BLUP", 
       y = "Density") + theme_bw()

p_int_qq <- ggplot(df_int, aes(sample = effect)) + stat_qq() + stat_qq_line() +
  labs(title = "Q–Q Plot of intercept residuals", x = "Theoretical quantiles", 
       y = "Sample quantiles") + theme_bw()

# slope residuals
p_slope_dens <- ggplot(df_slope, aes(x = effect)) + geom_density() +
  labs(title = "Distribution of slope residuals", x = "eventpl_w slope BLUP", 
       y = "Density") + theme_bw()

p_slope_qq <- ggplot(df_slope, aes(sample = effect)) + stat_qq() + stat_qq_line() +
  labs(title = "Q–Q Plot of slope residuals", x = "Theoretical quantiles", 
       y = "Sample quantiles") + theme_bw()

# plot
plot_grid(p_int_dens, p_int_qq, p_slope_dens, p_slope_qq)
```

![](4_files/figure-gfm/unnamed-chunk-25-1.png)<!-- -->

# Standardized / additional outputs

**Cohen’s d**

``` r
# model summary
summary(m3)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39707.38 39752.68 -19847.69
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9573536 (Intr)
    ## eventpl_w   0.1056453 -0.327
    ## Residual    0.9436220       
    ## 
    ## Fixed effects:  pa ~ eventpl_w 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.553894 0.05352444 13710 85.08065       0
    ## eventpl_w   0.189554 0.00813576 13710 23.29885       0
    ##  Correlation: 
    ##           (Intr)
    ## eventpl_w -0.232
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.78952092 -0.50284000  0.09444534  0.59143420  4.38937466 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

``` r
# cohens d for eventpl: (2*t)/sqrt(df)
(2 * 23.81798) / sqrt(13710)
```

    ## [1] 0.406833

**Confidence intervals**

``` r
# confidence intervals
intervals(m3, level = .95)
```

    ## Approximate 95% confidence intervals
    ## 
    ##  Fixed effects:
    ##                 lower     est.     upper
    ## (Intercept) 4.4489786 4.553894 4.6588090
    ## eventpl_w   0.1736067 0.189554 0.2055012
    ## 
    ##  Random Effects:
    ##   Level: id 
    ##                                  lower       est.      upper
    ## sd((Intercept))             0.88548275  0.9573536  1.0350580
    ## sd(eventpl_w)               0.09174146  0.1056453  0.1216563
    ## cor((Intercept),eventpl_w) -0.46309486 -0.3266790 -0.1751435
    ## 
    ##  Within-group standard error:
    ##     lower      est.     upper 
    ## 0.9324045 0.9436220 0.9549743

**Explained variance**

# Example write-up
