---
title: "Power analysis"
output:
  html_document:
    self_contained: no
---

```{r, include=F}
install.packages("simr")
```

There are several approaches to conduct power analyses for LMMs in `R`, e.g.:
- **simr**: Simulation-based function to estimate power of LMMs.  
- **mlpwr**: ML algorithm to find the optimal sample size and number of time points.  
- **PowerAnalysisLM**: A Shiny app for (longitudinal) LLMs that account for temporal dependencies in multi-level data.

# Example using `simr`:

```{r, message=F}
# load package
library(simr)

# seed
set.seed(123)
```

**Planned study**:  
Intervention for patients with depression. Participants are randomized to treatment vs control groups and complete weekly PHQ-9 assessments. A linear mixed-effects model with random intercepts and slopes evaluates the week × group interaction.

**Model outline**:  
`PHQ9 ~ week * group + (week | id)`

```{r, message=F}
# create design data
id <- factor(1:40)
time <- 1:6
group <- c("control", "intervention")

df <- data.frame(id = rep(id, each = length(time)),
                   time = rep(time, length(id)),
                   group = rep(rep(group, each = length(time)), 
                               length(id)/2))

head(df, n = 20)
```

**Plausible parameter values**:  
Fixed effects: 
`b0` (baseline mean, control): 14   
`b1` (weekly change, control): −0.2/week   
`b2` (baseline arm difference): 0   
`b3` (additional weekly change with treatment): −0.5/week   
  
Random effects (between-person variability)   
SD(b0) (random intercept): 3 (Var = 9)  
SD(b1) (random slope per week): 0.25 (Var = 0.0625)  
Corr(b0, b1): −0.3 (people starting higher tend to improve faster)   
  
Residual SD: 2.5 (Var = 6.25)

```{r}
# intercept and slopes for group, time, and group:time
fixed <- c(14, 0, -0.2, -0.5)

# random intercepts and slope (variance)
rand <- list(9, -0.3, 0.0625)

# residual (standard deviation)
res <- 2.5
```

**Standardized effect size**
d<sub>GMA</sub> = \\
( &beta;<sub>3</sub> &times; T ) / SD<sub>pooled,&nbsp;pre</sub> \\
= ( -0.5 &times; 5 ) / &radic;(9 + 6.25) \\
= ( -0.5 &times; 5 ) / 3.905
&asymp; -0.64

d<sub>GMA</sub> =    
( &beta;<sub>3</sub> &times; T ) / SD<sub>pooled,&nbsp;pre</sub>  
= ( -0.5 &times; 5 ) / &radic;(9 + 6.25)  
= ( -0.5 &times; 5 ) / 3.905  
&asymp; -0.64

$$
\text{Level 1: } y_{ij}
= \color{blue}\beta_{0j}
\color{black}+ \color{blue}\beta_{1j}\color{gray}w_{ij}
\color{black}+ \color{red}\varepsilon_{ij}
$$


**Fit model**
```{r}
model <- makeLmer(y ~ group * time + (time|id),
                  fixef=fixed, VarCorr=rand, sigma=res, data=df)
summary(model)
```

```{r, results='hide', message=F}
# power analysis
sim <- powerSim(model, nsim = 250, test = fixed("group:time"))
```

```{r}
sim
```

```{r, results='hide', message=F}
# changing the number of participants
model_ext_id <- extend(model, along = "id", n = 100)

p_curve <- powerCurve(model_ext_id, nsim = 250, 
                      test = fixed("group:time"), 
                      along = "id", 
                      breaks = c(20, 40, 60, 80, 100))
```

```{r}
plot(p_curve)
```

```{r, results='hide', message=F}
# changing the number of timepoints
model_ext_time <- extend(model, along = "time", n = 12)

p_curve <- powerCurve(model_ext_time, nsim = 250, 
                      test = fixed("group:time"), 
                      along = "time", 
                      breaks = c(4, 6, 8, 10, 12))
```

```{r}
plot(p_curve)
```

```{r, results='hide', message=F}
# changing both the number of participants and timepoints
# create design data
id <- factor(1:80)
time <- 1:8
group <- c("control", "intervention")

data <- data.frame(id = rep(id, each = length(time)),
                   time = rep(time, length(id)),
                   group = rep(rep(group, each = length(time)), 
                               length(id)/2))

# fit model
model_final <- makeLmer(y ~ group*time + (time|id),
                  fixef=fixed, VarCorr=rand, sigma=res, data=data)

# power analysis
sim <- powerSim(model_final, nsim = 250, test = fixed("group:time"))
```

```{r}
sim
```

# Exercises

1. Estimate the sample size needed to test a difference in treatment vs control group .

2. Estimate the power of the `eventpl` effect in model `m3`. (`simr` will throw a warning on post-hoc power analysis.)

