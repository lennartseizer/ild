Preprocessing
================

Preprocessing can be organized along a reproducible workflow: (1)
understand the study design, (2) reliably import the raw data, (3)
validate measurement windows, (4) classify missing and problematic
observations, (5) compute scales and derived variables, (6) generate the
analysis dataset for the target model (e.g., LMM). Each step should be
documented in scripts to ensure that the analyses remain transparent and
reproducible.

<figure>
<img src="https://www.researchgate.net/profile/Sheen-Levine/publication/325941519/figure/fig2/AS:824194581422080@1573514709439/The-Datasaurus-Dozen-Matejka-Fitzmaurice-2017-an-extension-of-Anscombes-quartet.ppm">
<figcaption>
The Datasaurus Dozen: All of them have identical descriptive statistics
(Matejka & Fitzmaurice, 2017).
</figcaption>
</figure>

# Get data

``` r
# set environment
library(dplyr)
library(ggplot2)
library(cowplot)
```

``` r
# load example data
data <- read.delim("https://www.kuleuven.be/samenwerking/real/real-book/viechtbauer2022_data_esmda_example")

str(data)
```

    ## 'data.frame':    19680 obs. of  27 variables:
    ##  $ id          : chr  "c100" "c100" "c100" "c100" ...
    ##  $ age         : int  30 30 30 30 30 30 30 30 30 30 ...
    ##  $ sex         : chr  "female" "female" "female" "female" ...
    ##  $ status      : chr  "control" "control" "control" "control" ...
    ##  $ day         : int  1 1 1 1 1 1 1 1 1 1 ...
    ##  $ beep        : int  1 2 3 4 5 6 7 8 9 10 ...
    ##  $ obs         : int  1 2 3 4 5 6 7 8 9 10 ...
    ##  $ beeptime    : int  477 585 718 756 874 982 1079 1133 1215 1301 ...
    ##  $ resptime    : int  480 NA 721 759 876 988 1082 1138 1219 1304 ...
    ##  $ resphour    : num  8 NA 12 12.7 14.6 ...
    ##  $ tothours    : num  8 NA 12 12.7 14.6 ...
    ##  $ mood_cheerf : int  5 NA 6 4 5 6 4 6 5 4 ...
    ##  $ mood_relaxed: int  4 NA 5 4 4 4 4 5 5 4 ...
    ##  $ mood_satisfi: int  5 NA 5 4 4 5 4 5 5 5 ...
    ##  $ mood_irritat: int  1 NA 1 6 2 6 4 2 1 1 ...
    ##  $ mood_anxious: int  1 NA 1 1 1 1 1 1 1 1 ...
    ##  $ mood_down   : int  1 NA 1 6 1 1 1 1 1 1 ...
    ##  $ mood_guilty : int  1 NA 1 1 1 1 1 1 1 1 ...
    ##  $ mood_insecur: int  1 NA 1 1 1 1 1 1 1 1 ...
    ##  $ mood_lonely : int  1 NA 1 1 1 1 1 1 1 1 ...
    ##  $ eventpl     : int  0 NA 2 -2 3 NA 3 NA 3 2 ...
    ##  $ soc_alone   : int  0 NA 0 0 0 0 0 0 0 0 ...
    ##  $ soc_pleasant: int  7 NA 7 7 7 4 6 7 7 7 ...
    ##  $ act_else    : int  2 NA 1 7 2 7 6 3 1 7 ...
    ##  $ use_coffee  : int  0 NA 0 0 0 1 0 0 0 0 ...
    ##  $ use_alcohol : int  0 NA 0 0 0 0 0 0 0 0 ...
    ##  $ location    : chr  "home" "" "home" "home" ...

**Design variables**: the study `day` (1 to 6), the `beep` number within
each day (1 to 10) and `beeptime` (in minutes after midnight) on each
day, the overall number of observations `obs` (1 to 60), the response
time `resptime` (in minutes after midnight)

**Subject-level, time-invariant variables**: the participants’ `age` (in
years), `sex` (female, male), and mental health `status` (control,
depressed, psychotic)

**Time-varying response variables**: 3 items to assess positive affect
and 6 items to assess negative affect (1 to 7 Likert scale), the
pleasantness of events that had occurred since the previous beep
`eventpl` (−3 to +3 bipolar scale), whether the person was alone at the
time of the beep `soc_alone` (1 = alone, 0 = not alone) and when the
person was not alone) a rating how pleasant the company is
`soc_pleasant` (1 to 7 Likert scale), and whether they had consumed
coffee / alcohol since the previous beep (1 = yes, 0 = no)

<figure>
<img src="https://carpentry.library.ucsb.edu/2023-01-23-ucsb-r/fig/14-tidyr-fig3.png">
</figure>

# Design and sampling scheme

``` r
# number of participants
length(unique(data$id))
```

    ## [1] 328

``` r
# number of planned observations 
nrow(data)
```

    ## [1] 19680

``` r
# missing values in design variables?
design_vars <- c("id", "day", "beep", "beeptime", "obs")

data %>%
  summarise(across(all_of(design_vars), ~ any(is.na(.))))
```

    ##      id   day  beep beeptime   obs
    ## 1 FALSE FALSE FALSE    FALSE FALSE

``` r
# no variance in time-invariant variables?
l2_vars <- c("age", "sex", "status")

data %>%
  group_by(id) %>%
  summarise(across(all_of(l2_vars), ~ n_distinct(.) == 1), 
            .groups = "drop") %>%
  summarise(across(all_of(l2_vars), all))
```

    ## # A tibble: 1 × 3
    ##   age   sex   status
    ##   <lgl> <lgl> <lgl> 
    ## 1 TRUE  TRUE  TRUE

# Participants response behaviors

``` r
# compute the response frequencies
data$compl <- !is.na(data$resptime)

# histogram of the response frequencies
p_comp1 <- ggplot(aggregate(data, compl ~ id, sum), aes(x = compl)) +
  geom_bar() + theme_bw() + xlab("Number of assessments") +
  ggtitle("Response Frequency")

# histogram of the compliance
p_comp2 <- ggplot(aggregate(data, compl ~ id, sum), 
                  aes(x = compl / 60 * 100)) + geom_bar() + theme_bw() + 
                  xlab("Percentage of assessments") 

plot_grid(p_comp1, p_comp2)
```

![](2_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->

``` r
# summary of compliance
summary(aggregate(data, compl ~ id, sum)$compl / 60 * 100)
```

    ##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    ##   33.33   65.00   77.50   75.67   88.33  100.00

``` r
# compute response delays
data$delay <- data$resptime - data$beeptime

# barplot of the delay 
ggplot(data, aes(x = delay)) + geom_bar() + theme_minimal() 
```

    ## Warning: Removed 4789 rows containing non-finite outside the scale range
    ## (`stat_count()`).

![](2_files/figure-gfm/unnamed-chunk-8-1.png)<!-- -->

# Compute and transform variables

xxx

``` r
# check distributions and out-of-range values
hist1 <- ggplot(data, aes(x = mood_relaxed)) + geom_bar() + theme_bw() +
  ggtitle("Mood: Relaxed")

hist2 <- ggplot(data, aes(x = mood_down)) + geom_bar() + theme_bw() +
  ggtitle("Mood: Down")

hist3 <- ggplot(data, aes(x = eventpl)) + geom_bar() + theme_bw() +
  ggtitle("Event pleaseantness")

hist4 <- ggplot(data, aes(x = age)) + geom_bar() + theme_bw() +
  ggtitle("Age")

plot_grid(hist1, hist2, hist3, hist4)
```

![](2_files/figure-gfm/unnamed-chunk-9-1.png)<!-- -->

``` r
# summary of L2-variables
head(aggregate(data, age ~ id, unique))
```

    ##     id age
    ## 1 c100  30
    ## 2 c101  32
    ## 3 c102  33
    ## 4 c103  47
    ## 5 c104  30
    ## 6 c105  35

``` r
# compute scales of positive and negative affect
data$pa <- rowMeans(data[,c("mood_cheerf", "mood_relaxed", "mood_satisfi")])

data$na <- rowMeans(data[,c("mood_irritat", "mood_anxious", "mood_down", 
                            "mood_guilty", "mood_insecur", "mood_lonely")])
```

``` r
# separate variables into within and between parts (event pleasantness)

# compute person-means 
data$eventpl_b <- ave(data$eventpl, data$id, FUN=function(x)mean(x, na.rm = TRUE)) 

# person-mean centering
data$eventpl_w <- data$eventpl - data$eventpl_b 

# compute grand-mean 
eventpl_gm <- mean(aggregate(data, eventpl_b ~ id, unique)$eventpl_b)

# person-mean centering
data$eventpl_bc <- data$eventpl_b - eventpl_gm

head(data[, c("id", "day", "beep", "eventpl","eventpl_b", "eventpl_w", "eventpl_bc")])
```

    ##     id day beep eventpl eventpl_b eventpl_w eventpl_bc
    ## 1 c100   1    1       0       2.4      -2.4   1.035615
    ## 2 c100   1    2      NA       2.4        NA   1.035615
    ## 3 c100   1    3       2       2.4      -0.4   1.035615
    ## 4 c100   1    4      -2       2.4      -4.4   1.035615
    ## 5 c100   1    5       3       2.4       0.6   1.035615
    ## 6 c100   1    6      NA       2.4        NA   1.035615

``` r
# plot between part of event_pl
id_select <- unique(data$id)[1:20]

data %>% filter(id %in% id_select) %>%
  ggplot(aes(x = obs, y = eventpl_b, col = id)) +
     geom_hline(yintercept = eventpl_gm, lty = "dashed", lwd = 1) +
     geom_line() + theme_bw() + 
     theme(legend.position = "none") 
```

![](2_files/figure-gfm/unnamed-chunk-13-1.png)<!-- -->

``` r
# plot within part of event_pl
id_select <- unique(data$id)[1:20]

data %>% filter(id %in% id_select) %>%
  ggplot(aes(x = obs, y = eventpl_w, col = id)) +
     geom_line() + geom_point() + facet_wrap(~id) +
     theme_bw() + theme(legend.position = "none")
```

![](2_files/figure-gfm/unnamed-chunk-14-1.png)<!-- -->

``` r
# create lagged variables
data <- data %>%
  arrange(id, obs) %>%                
  group_by(id) %>%                     
  mutate(eventpl_w_l1 = lag(eventpl_w, n = 1)) %>% # lag by 1 obs
  mutate(eventpl_w_l1 = if_else(beep == 1, NA, eventpl_w_l1)) %>% # reset each day
  ungroup()

head(data[, c("id", "day", "beep", "eventpl_w", "eventpl_w_l1")], n = 15)
```

    ## # A tibble: 15 × 5
    ##    id      day  beep eventpl_w eventpl_w_l1
    ##    <chr> <int> <int>     <dbl>        <dbl>
    ##  1 c100      1     1      -2.4         NA  
    ##  2 c100      1     2      NA           -2.4
    ##  3 c100      1     3      -0.4         NA  
    ##  4 c100      1     4      -4.4         -0.4
    ##  5 c100      1     5       0.6         -4.4
    ##  6 c100      1     6      NA            0.6
    ##  7 c100      1     7       0.6         NA  
    ##  8 c100      1     8      NA            0.6
    ##  9 c100      1     9       0.6         NA  
    ## 10 c100      1    10      -0.4          0.6
    ## 11 c100      2     1      NA           NA  
    ## 12 c100      2     2       0.6         NA  
    ## 13 c100      2     3       0.6          0.6
    ## 14 c100      2     4       0.6          0.6
    ## 15 c100      2     5      NA            0.6

# visualization

``` r
unique(data$id)[1:20]
```

    ##  [1] "c100" "c101" "c102" "c103" "c104" "c105" "c106" "c107" "c108" "c109"
    ## [11] "c110" "c111" "c112" "c113" "c114" "c115" "c116" "c117" "c118" "c119"

``` r
data %>% filter(id %in% id_select) %>%
  ggplot(aes(x = obs, y = pa, col = id)) +
     geom_line() + geom_point() + facet_wrap(~id) +
     theme_bw() + theme(legend.position = "none")
```

![](2_files/figure-gfm/unnamed-chunk-16-1.png)<!-- -->

``` r
id_select <- unique(data$id)[1:20]

data %>% filter(id %in% id_select) %>%
     ggplot(aes(x=obs, y=mood_relaxed)) +
     geom_line() +
     geom_point() +
     facet_grid(id~., scales="free") 
```

![](2_files/figure-gfm/unnamed-chunk-17-1.png)<!-- -->

# References & Further reading

Matejka, J., & Fitzmaurice, G. (2017). Same stats, different graphs:
generating datasets with varied appearance and identical statistics
through simulated annealing. In Proceedings of the 2017 CHI conference
on human factors in computing systems (pp. 1290-1294).
