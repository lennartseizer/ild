Fitting mixed-effects models
================

| Feature / Task                 | **lme4 (lmer)**                          | **nlme (lme)**                           |
|--------------------------------|------------------------------------------|------------------------------------------|
| Main function                  | `lmer()`                                 | `lme()`                                  |
| Syntax for random intercepts   | `lmer(y ~ 1 + (1|id), data = df)`        | `lme(y ~ 1, random = ~1|id, data = df)`  |
| Random slopes                  | `lmer(y ~ x + (x|id), data = df)`        | `lme(y ~ x, random = ~x|id, data = df)`  |
| Multiple grouping factors      | Yes (nested/crossed)                     | Limited, mostly nested                   |
| Estimation method              | REML / ML (fast, sparse matrices)        | REML / ML (older implementation)         |
| Handles heteroscedasticity     | Not directly                             | Yes, via `weights = varIdent(...)`       |
| Correlation structures         | Not directly                             | Yes, via `corAR1`, `corCompSymm`, etc.   |
| Extract fixed effects          | `fixef(model)`                           | `fixef(model)`                           |
| Extract random effects (BLUPs) | `ranef(model)`                           | `ranef(model)`                           |
| Fitted values                  | `fitted(model)`                          | `fitted(model)`                          |
| P-values for fixed effects     | Not provided by default (use `lmerTest`) | Provided directly in summary output      |
| Speed / scalability            | Very fast, good for large data           | Slower, better for smaller/moderate data |

# Null model

``` r
# set environment
library(nlme)
library(lme4)
library(ggplot2)
library(cowplot)
library(scales)
library(r2mlm)
library(tidyr)
library(parameters)
library(reshape2)
library(HLMdiag)
library(sjPlot)
```

``` r
# fit null model
m1 <- lme(pa ~ 1, 
          random = ~1|id,
          data = data, 
          na.action = na.exclude)

summary(m1)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   43350.01 43372.82 -21672.01
    ## 
    ## Random effects:
    ##  Formula: ~1 | id
    ##         (Intercept) Residual
    ## StdDev:   0.9597608 1.004858
    ## 
    ## Fixed effects:  pa ~ 1 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.549196 0.05366659 14464 84.76775       0
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -5.2911753 -0.5171447  0.1007566  0.5907290  4.2945047 
    ## 
    ## Number of Observations: 14792
    ## Number of Groups: 328

``` r
# fixed effects
fixef(m1)
```

    ## (Intercept) 
    ##    4.549196

``` r
# random effects
head(ranef(m1))
```

    ##      (Intercept)
    ## c100   0.5557835
    ## c101   0.1352157
    ## c102  -0.3672321
    ## c103   2.1116416
    ## c104   1.8477497
    ## c105   1.5633701

**Plot estimates**

``` r
# individual intercepts and residuals
hist1 <- ggplot(data.frame(value = coef(m1)[[1]]), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30) +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(x = "Average Positive Affect", y = "Density") +
  theme_bw()

hist2 <- ggplot(data.frame(value = resid(m1)), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30) +
  geom_density(linewidth = 0.8, color = "blue") +
  labs(x = "Residual", y = "Density") +
  theme_bw()
  
cowplot::plot_grid(hist1, hist2)
```

![](4_files/figure-gfm/unnamed-chunk-5-1.png)<!-- -->

**Shrinkage: compare pooled vs non-pooled means**

``` r
# compute individual means
indiv_means <- data %>%
  group_by(id) %>%
  summarise(indiv_mean = mean(pa, na.rm = TRUE)) %>%
  ungroup()

# plot pooled vs non-pooled means
hist1 <- ggplot(data.frame(value = coef(m1)[[1]]), aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30) +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(title = "Average Positive Affect", x = "BLUPs") +
  theme_bw()

hist2 <- ggplot(data.frame(value = indiv_means$indiv_mean), 
                aes(x = value)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30) +
  geom_density(linewidth = 0.8, color = "blue") +
  scale_x_continuous(breaks = 1:7) +
  labs(title = "Average Positive Affect", x = "Observed means") +
  theme_bw()
  
cowplot::plot_grid(hist1, hist2)
```

![](4_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->

``` r
# pooled vs non-pooled means
head(data.frame(BLUP = coef(m1)[[1]], 
                Obs_Means = indiv_means$indiv_mean))
```

    ##       BLUP Obs_Means
    ## 1 5.104980  5.118519
    ## 2 4.684412  4.687500
    ## 3 4.181964  4.175141
    ## 4 6.660838  6.703704
    ## 5 6.396946  6.435897
    ## 6 6.112566  6.151515

**Intraclass Correlation Coefficient (ICC)**

``` r
int_var <- getVarCov(m1)[1,1] # random intercept variance
res_var <- sigma(m1)^2 # residual variance

int_var / (int_var + res_var)
```

    ## [1] 0.4770572

# Adding time as a predictor

``` r
# plot time variables
d <- data %>% filter(id == "c100") %>% mutate(idx = row_number())

t1 <- ggplot(d, aes(idx, obs)) + geom_line() + geom_point() + 
  labs(x="Index", y="obs") + theme_bw()
t2 <- ggplot(d, aes(idx, day)) + geom_line() + geom_point() + 
  labs(x="Index", y="day") + theme_bw()
t3 <- ggplot(d, aes(idx, beep)) + geom_line() + geom_point() + 
  labs(x="Index", y="beep") + theme_bw()
t4 <- ggplot(d, aes(idx, resptime)) + geom_line() + geom_point() + 
  labs(x="Index", y="resptime") + theme_bw()

cowplot::plot_grid(t1, t2, t3, t4)
```

![](4_files/figure-gfm/unnamed-chunk-8-1.png)<!-- -->

**Variance decomposition based on time variables**

``` r
# intercept-only model with time-variance components 
m2_lme <- lme(pa ~ 1, 
              random = ~1|id/day/beep,
              data = data, 
              na.action = na.exclude)

m2_lmer <- lmer(pa ~ 1 + (1|id) + (1|day) + (1 | beep) + (1|id:day) +
                  (1|id:beep) + (1|day:beep),
                data = data)

# model summaries
summary(m2_lme)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   42294.84 42332.85 -21142.42
    ## 
    ## Random effects:
    ##  Formula: ~1 | id
    ##         (Intercept)
    ## StdDev:   0.9438547
    ## 
    ##  Formula: ~1 | day %in% id
    ##         (Intercept)
    ## StdDev:   0.4587897
    ## 
    ##  Formula: ~1 | beep %in% day %in% id
    ##         (Intercept)  Residual
    ## StdDev:   0.8407285 0.3576615
    ## 
    ## Fixed effects:  pa ~ 1 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.550016 0.05373072 12850 84.68184       0
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -2.18304104 -0.18747558  0.03813573  0.21591558  1.53930184 
    ## 
    ## Number of Observations: 14792
    ## Number of Groups: 
    ##                    id           day %in% id beep %in% day %in% id 
    ##                   328                  1942                 14792

``` r
summary(m2_lmer)
```

    ## Linear mixed model fit by REML ['lmerMod']
    ## Formula: pa ~ 1 + (1 | id) + (1 | day) + (1 | beep) + (1 | id:day) + (1 |  
    ##     id:beep) + (1 | day:beep)
    ##    Data: data
    ## 
    ## REML criterion at convergence: 42190.9
    ## 
    ## Scaled residuals: 
    ##     Min      1Q  Median      3Q     Max 
    ## -5.5256 -0.4696  0.0917  0.5460  3.8197 
    ## 
    ## Random effects:
    ##  Groups   Name        Variance  Std.Dev. 
    ##  id:beep  (Intercept) 2.289e-02 1.513e-01
    ##  id:day   (Intercept) 2.134e-01 4.620e-01
    ##  id       (Intercept) 8.905e-01 9.437e-01
    ##  day:beep (Intercept) 6.700e-10 2.588e-05
    ##  beep     (Intercept) 7.441e-03 8.626e-02
    ##  day      (Intercept) 0.000e+00 0.000e+00
    ##  Residual             8.055e-01 8.975e-01
    ## Number of obs: 14792, groups:  
    ## id:beep, 3226; id:day, 1942; id, 328; day:beep, 60; beep, 10; day, 6
    ## 
    ## Fixed effects:
    ##             Estimate Std. Error t value
    ## (Intercept)  4.54171    0.06032    75.3
    ## optimizer (nloptwrap) convergence code: 0 (OK)
    ## boundary (singular) fit: see help('isSingular')

``` r
# extract variance components
vc <- as.data.frame(VarCorr(m2_lmer)) %>%
  group_by(grp) %>%
  summarise(vcov = sum(vcov), .groups = "drop") %>%
  mutate(Prop = vcov / sum(vcov)) %>%
  arrange(Prop)

# plot variance components
ggplot(vc, aes(x = Prop, y = reorder(grp, Prop), fill = grp)) +
  geom_col(width = 0.7, color = "white", show.legend = FALSE) +
  geom_text(aes(label = percent(Prop, accuracy = 0.1)),
            hjust = -0.1, size = 3.2) +
  scale_x_continuous(labels = percent_format(accuracy = 1),
                     expand = expansion(mult = c(0, 0.1))) +
  labs(title = "Variance decomposition for PA",
       x = "Proportion of variance", y = NULL) +
  theme_bw(base_size = 12) 
```

![](4_files/figure-gfm/unnamed-chunk-9-1.png)<!-- -->

# Adding a L1 predictor

``` r
# fit model with predictor
m3 <- lme(pa ~ eventpl_w, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.exclude)

summary(m3)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39707.38 39752.68 -19847.69
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9573947 (Intr)
    ## eventpl_w   0.1056456 -0.327
    ## Residual    0.9436210       
    ## 
    ## Fixed effects:  pa ~ eventpl_w 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.553894 0.05352668 13710 85.07709       0
    ## eventpl_w   0.189554 0.00813577 13710 23.29883       0
    ##  Correlation: 
    ##           (Intr)
    ## eventpl_w -0.232
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.78953079 -0.50284064  0.09444142  0.59143584  4.38938541 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

``` r
# fixed effects
fixef(m3)
```

    ## (Intercept)   eventpl_w 
    ##    4.553894    0.189554

``` r
# random effects
head(ranef(m3))
```

    ##      (Intercept)   eventpl_w
    ## c100   0.5731366 -0.03132768
    ## c101   0.1362071 -0.08478616
    ## c102  -0.3696327  0.02588955
    ## c103   2.1088001 -0.03187164
    ## c104   1.7994975 -0.07237086
    ## c105   1.5605062  0.01566263

**Plot estimates**

``` r
# extract random estimates
cf <- as.data.frame(coef(m3))
names(cf)[1:2] <- c("Intercept", "Slope") 
res_df <- data.frame(Residual = resid(m3))

# intercepts
p_int <- ggplot(cf, aes(x = Intercept)) +
  geom_histogram(bins = 30, aes(y = after_stat(density))) +
  geom_density(linewidth = 0.8, color = "blue") +
  labs(x = "Intercepts", y = "Density") + theme_bw()

# slopes
p_slope <- ggplot(cf, aes(x = Slope)) +
  geom_histogram(bins = 30, aes(y = after_stat(density))) +
  geom_density(linewidth = 0.8, color = "blue") +
  labs(x = "Slopes", y = "Density") + theme_bw()

# residuals
p_res <- ggplot(res_df, aes(x = Residual)) +
  geom_histogram(bins = 30, aes(y = after_stat(density))) +
  geom_density(linewidth = 0.8, color = "blue") +
  labs(x = "Residuals", y = "Density") + theme_bw()

# intercept vs slope with fixed-effect reference lines
p_scatter <- ggplot(cf, aes(x = Intercept, y = Slope)) +
  geom_point(alpha = 0.6) + 
  geom_vline(xintercept = as.numeric(fixef(m3)[1]), linetype="dotted") +
  geom_hline(yintercept = as.numeric(fixef(m3)[2]), linetype="dotted") +
  labs(x = "Intercept", y = "Slope") + theme_bw()

# plot
cowplot::plot_grid(p_int, p_slope, p_res, p_scatter)
```

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_bin()`).

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_density()`).

![](4_files/figure-gfm/unnamed-chunk-12-1.png)<!-- -->

**Spaghetti plot**

``` r
data_plot <- data %>% mutate(pred = predict(m3)) 

ggplot(data_plot, aes(x = eventpl_w, y = pa, group = id)) +
  # individual lines
  geom_line(aes(y = pred, color = id), alpha = 0.4, linewidth = 0.6) +
  # population-level line
  geom_abline(intercept = fixef(m3)[1], slope = fixef(m3)[2], 
              color = "black", linewidth = 1.2) +
  # aesthetics
  scale_color_viridis_d(option = "turbo", guide = "none") +
  theme_bw(base_size = 12) +
  labs(x = "Event Pleasantness (within-person)",
       y = "Predicted Positive Affect")
```

![](4_files/figure-gfm/unnamed-chunk-13-1.png)<!-- -->

**Explained variance**

``` r
# decomposition
r2mlm_manual(
  data = data %>% select(all_of(all.vars(formula(m3)))) %>% drop_na(), 
  within_covs = c("eventpl_w"),
  between_covs = NULL,
  random_covs = c("eventpl_w"),
  gamma_w = unname(fixef(m3)["eventpl_w"]),
  gamma_b = unname(fixef(m3)[c("(Intercept)")]),
  Tau = as.matrix(getVarCov(m3)),
  sigma2 = sigma(m3)^2
)
```

![](4_files/figure-gfm/unnamed-chunk-14-1.png)<!-- -->

**Nakagawa’s R2** R<sup>2</sup><sub>m</sub> = (
σ<sup>2</sup><sub>fixed</sub> ) / ( σ<sup>2</sup><sub>fixed</sub> +
σ<sup>2</sup><sub>random</sub> + σ<sup>2</sup><sub>residual</sub> )     
R<sup>2</sup><sub>c</sub> = ( σ<sup>2</sup><sub>fixed</sub> +
σ<sup>2</sup><sub>random</sub> ) / ( σ<sup>2</sup><sub>fixed</sub> +
σ<sup>2</sup><sub>random</sub> + σ<sup>2</sup><sub>residual</sub> )

``` r
# extract variances
var_fixed <- var(predict(m3, level = 0), na.rm = T)
var_rand  <- sum(diag(as.matrix(getVarCov(m3))))
var_res <- sigma(m3)^2

# calculate R2s
R2m <- var_fixed / (var_fixed + var_rand + var_res)
R2c <- (var_fixed + var_rand) / (var_fixed + var_rand + var_res)

c(R2_marginal = R2m, R2_conditional = R2c)
```

    ##    R2_marginal R2_conditional 
    ##     0.04650934     0.53304691

``` r
# with helper function
performance::r2(m3)
```

    ## # R2 for Mixed Models
    ## 
    ##   Conditional R2: 0.537
    ##      Marginal R2: 0.046

# Adding covariates

**L2 covariate**

``` r
# fit model with L2 covariates
m4 <- lme(pa ~ eventpl_w + eventpl_bc + age, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.exclude)

summary(m4)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39640.81 39701.21 -19812.41
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.8392177 (Intr)
    ## eventpl_w   0.1053072 -0.307
    ## Residual    0.9436623       
    ## 
    ## Fixed effects:  pa ~ eventpl_w + eventpl_bc + age 
    ##                 Value  Std.Error    DF   t-value p-value
    ## (Intercept)  4.821536 0.16167400 13710 29.822585  0.0000
    ## eventpl_w    0.192174 0.00812969 13710 23.638569  0.0000
    ## eventpl_bc   0.628619 0.06526224   325  9.632196  0.0000
    ## age         -0.007342 0.00423765   325 -1.732539  0.0841
    ##  Correlation: 
    ##            (Intr) evntpl_w evntpl_b
    ## eventpl_w  -0.049                  
    ## eventpl_bc  0.023  0.033           
    ## age        -0.957 -0.014   -0.024  
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.78149181 -0.50255127  0.08942043  0.59530978  4.40600400 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

``` r
# fixed effects
fixef(m4)
```

    ##  (Intercept)    eventpl_w   eventpl_bc          age 
    ##  4.821536496  0.192174120  0.628618766 -0.007341887

``` r
# random effects
head(ranef(m4))
```

    ##      (Intercept)   eventpl_w
    ## c100 -0.10143443 -0.01485741
    ## c101 -0.01720416 -0.08346291
    ## c102 -0.69510098  0.03258872
    ## c103  1.29768422 -0.01077902
    ## c104  1.84813855 -0.07636340
    ## c105  1.19444220  0.01961858

``` r
# grand-mean center age
data$age_c <- data$age - mean(aggregate(data, age ~ id, unique)$age)

# fit model with L2 covariate
m4_c <- lme(pa ~ eventpl_w + eventpl_bc + age_c, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.exclude)

summary(m4_c)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39640.81 39701.21 -19812.41
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.8392177 (Intr)
    ## eventpl_w   0.1053072 -0.307
    ## Residual    0.9436623       
    ## 
    ## Fixed effects:  pa ~ eventpl_w + eventpl_bc + age_c 
    ##                 Value  Std.Error    DF  t-value p-value
    ## (Intercept)  4.553893 0.04709197 13710 96.70213  0.0000
    ## eventpl_w    0.192174 0.00812969 13710 23.63857  0.0000
    ## eventpl_bc   0.628619 0.06526225   325  9.63220  0.0000
    ## age_c       -0.007342 0.00423765   325 -1.73254  0.0841
    ##  Correlation: 
    ##            (Intr) evntpl_w evntpl_b
    ## eventpl_w  -0.216                  
    ## eventpl_bc  0.000  0.033           
    ## age_c      -0.004 -0.014   -0.024  
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.78149179 -0.50255126  0.08942045  0.59530980  4.40600404 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

**Explained variance**

``` r
# decomposition
r2mlm_manual(
  data = data %>% select(all_of(all.vars(formula(m4)))) %>% drop_na(), 
  within_covs = c("eventpl_w"),
  between_covs = c("eventpl_bc","age"),
  random_covs = c("eventpl_w"),
  gamma_w = unname(fixef(m4)["eventpl_w"]),
  gamma_b = unname(fixef(m4)[c("(Intercept)","eventpl_bc","age")]),
  Tau = as.matrix(getVarCov(m4)),
  sigma2 = sigma(m4)^2
)
```

![](4_files/figure-gfm/unnamed-chunk-19-1.png)<!-- -->

**Nakagawa’s R2**

``` r
performance::r2(m4)
```

    ## # R2 for Mixed Models
    ## 
    ##   Conditional R2: 0.532
    ##      Marginal R2: 0.148

**L1 covariate**

``` r
# fit model with L1 covariate
m5 <- lme(pa ~ eventpl_w + use_alcohol, 
          random = ~eventpl_w + use_alcohol|id,
          data = data, 
          na.action = na.exclude)

summary(m5)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39129.37 39204.72 -19554.69
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w + use_alcohol | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr         
    ## (Intercept) 0.9566028 (Intr) evntp_
    ## eventpl_w   0.1036062 -0.331       
    ## use_alcohol 0.2762781 -0.098  0.478
    ## Residual    0.9413193              
    ## 
    ## Fixed effects:  pa ~ eventpl_w + use_alcohol 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.539428 0.05354384 13505 84.77966       0
    ## eventpl_w   0.187063 0.00808025 13505 23.15068       0
    ## use_alcohol 0.222357 0.04235658 13505  5.24964       0
    ##  Correlation: 
    ##             (Intr) evntp_
    ## eventpl_w   -0.231       
    ## use_alcohol -0.071  0.096
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.80268018 -0.50749419  0.09958428  0.58167263  4.10268280 
    ## 
    ## Number of Observations: 13835
    ## Number of Groups: 328

> `lme4` **package vignette:**  
> *There is not yet consensus about how to deal with singularity, or
> more generally to choose which random-effects specification (from a
> range of choices of varying complexity) to use. Some proposals
> include:*  
> - *avoid fitting overly complex models in the first place, i.e. design
> experiments/restrict models a priori such that the variance-covariance
> matrices can be estimated precisely enough to avoid singularity
> (Matuschek et al 2017)*  
> - *use some form of model selection to choose a model that balances
> predictive accuracy and overfitting/type I error (Bates et al 2015,
> Matuschek et al 2017)*  
> - *“keep it maximal”, i.e. fit the most complex model consistent with
> the experimental design, removing only terms required to allow a
> non-singular fit (Barr et al. 2013), or removing further terms based
> on p-values or AIC*

**Example RQ: within-participant** `eventpl` **-\>** `pa` **with
covariates** `use_alcohol` **and** `use_alcohol`

``` r
# base model
m6 <- lme(pa ~ eventpl_bc + use_alcohol + use_coffee, 
          random = ~1|id,
          data = data, 
          na.action = na.exclude)

# random effect for use_alcohol
m7 <- lme(pa ~ eventpl_bc + use_alcohol + use_coffee, 
          random = ~use_alcohol|id,
          data = data, 
          na.action = na.exclude)

anova(m6, m7)
```

    ##    Model df      AIC      BIC    logLik   Test  L.Ratio p-value
    ## m6     1  6 42489.69 42535.19 -21238.84                        
    ## m7     2  8 42474.28 42534.94 -21229.14 1 vs 2 19.40884   1e-04

``` r
# random effect for use_coffee
m8 <- lme(pa ~ eventpl_bc + use_alcohol + use_coffee, 
          random = ~use_coffee|id,
          data = data, 
          na.action = na.exclude)

anova(m6, m8)
```

    ##    Model df      AIC      BIC    logLik   Test  L.Ratio p-value
    ## m6     1  6 42489.69 42535.19 -21238.84                        
    ## m8     2  8 42489.32 42549.99 -21236.66 1 vs 2 4.367015  0.1126

``` r
# final model
m8 <- lme(pa ~ eventpl_w + eventpl_bc + use_alcohol + use_coffee, 
          random = ~eventpl_w + use_alcohol|id,
          data = data, 
          na.action = na.exclude)

summary(m8)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC   logLik
    ##   39060.39 39150.81 -19518.2
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w + use_alcohol | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr         
    ## (Intercept) 0.8437234 (Intr) evntp_
    ## eventpl_w   0.1031565 -0.321       
    ## use_alcohol 0.2740124 -0.115  0.466
    ## Residual    0.9413225              
    ## 
    ## Fixed effects:  pa ~ eventpl_w + eventpl_bc + use_alcohol + use_coffee 
    ##                Value  Std.Error    DF  t-value p-value
    ## (Intercept) 4.528802 0.04776044 13504 94.82328  0.0000
    ## eventpl_w   0.189385 0.00806778 13504 23.47423  0.0000
    ## eventpl_bc  0.620475 0.06547183   326  9.47698  0.0000
    ## use_alcohol 0.229839 0.04242561 13504  5.41745  0.0000
    ## use_coffee  0.036886 0.02079589 13504  1.77373  0.0761
    ##  Correlation: 
    ##             (Intr) evntpl_w evntpl_b us_lch
    ## eventpl_w   -0.220                         
    ## eventpl_bc   0.001  0.033                  
    ## use_alcohol -0.091  0.090    0.000         
    ## use_coffee  -0.122 -0.006   -0.009    0.092
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.77079210 -0.50344899  0.09619888  0.59049442  4.12439742 
    ## 
    ## Number of Observations: 13835
    ## Number of Groups: 328

# Moderation analysis

**Cross-level moderation**

``` r
# fit moderation model
m9 <- lme(pa ~ eventpl_w * status, 
          random = ~eventpl_w|id,
          data = data,
          na.action = na.exclude)

summary(m9)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39606.26 39681.75 -19793.13
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev     Corr  
    ## (Intercept) 0.83383825 (Intr)
    ## eventpl_w   0.09158584 -0.143
    ## Residual    0.94343315       
    ## 
    ## Fixed effects:  pa ~ eventpl_w * status 
    ##                               Value  Std.Error    DF  t-value p-value
    ## (Intercept)                5.188217 0.07999688 13708 64.85525  0.0000
    ## eventpl_w                  0.137072 0.01311980 13708 10.44771  0.0000
    ## statusdepressed           -1.111828 0.11385855   325 -9.76500  0.0000
    ## statuspsychotic           -0.813189 0.11470319   325 -7.08950  0.0000
    ## eventpl_w:statusdepressed  0.125438 0.01791229 13708  7.00289  0.0000
    ## eventpl_w:statuspsychotic  0.021742 0.01927813 13708  1.12783  0.2594
    ##  Correlation: 
    ##                           (Intr) evntp_ sttsdp sttsps evntpl_w:sttsd
    ## eventpl_w                 -0.093                                    
    ## statusdepressed           -0.703  0.065                             
    ## statuspsychotic           -0.697  0.065  0.490                      
    ## eventpl_w:statusdepressed  0.068 -0.732 -0.097 -0.048               
    ## eventpl_w:statuspsychotic  0.063 -0.681 -0.045 -0.091  0.498        
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.79477396 -0.50506749  0.09082617  0.58929667  4.28090423 
    ## 
    ## Number of Observations: 14039
    ## Number of Groups: 328

**Spaghetti plot**

``` r
# subject-specific predictions
data_plot <- data %>% mutate(pred_id = as.numeric(predict(m9, level = 1)))

# fixed effects matrix
fe <- fixef(m9)
grid_fe <- expand.grid(
  eventpl_w = c(min(data$eventpl_w, na.rm = TRUE), max(data$eventpl_w, na.rm = TRUE)),
  status    = levels(factor(data$status)))
grid_fe$yhat <- as.numeric(model.matrix(~ eventpl_w * status, data = grid_fe) %*% fe)

# plot
ggplot() +
  # individual lines
  geom_line(data = data_plot, aes(x = eventpl_w, y = pred_id, group = id, color = id),
            alpha = 0.45, linewidth = 0.6) +
  # population line per status
  geom_line(data = grid_fe, aes(x = eventpl_w, y = yhat, group = status), 
            linewidth = 1.3, color = "black") +
  facet_wrap(~ status, nrow = 1, scales = "free_x") + guides(color = "none") + 
  theme_bw(base_size = 12) +
  labs(x = "Event pleasantness (within-person)", 
       y = "Predicted positive affect")
```

![](4_files/figure-gfm/unnamed-chunk-24-1.png)<!-- -->

**Random effect distributions**

``` r
# subject-specific predictions
re <- as.data.frame(ranef(m9))
re$id <- rownames(re)
re <- re %>% select(id, re_slope = `eventpl_w`)

# fixed effects 
id_status <- data %>% distinct(id, status) %>% mutate(id = as.character(id))
fe <- fixef(m9)
lvl <- levels(factor(data$status))
get_fixed_slope <- function(st) {
  base <- unname(fe["eventpl_w"])
  term <- paste0("eventpl_w:status", st)
  if (!is.na(fe[term])) base <- base + unname(fe[term])
  base
}
fixed_by_status <- setNames(sapply(lvl, get_fixed_slope), lvl)

# subject-specific slope = fixed(status) + random slope
df_slopes <- re %>%
  left_join(id_status, by = "id") %>%
  mutate(fixed_slope = fixed_by_status[as.character(status)],
         slope_hat   = fixed_slope + re_slope) %>%
  filter(!is.na(status))

# overlapping densities with vertical lines at status group means
group_means <- df_slopes %>%
  group_by(status) %>%
  summarise(mean_slope = mean(slope_hat, na.rm = TRUE), .groups = "drop")

ggplot(df_slopes, aes(x = slope_hat, fill = status)) +
  geom_density(alpha = 0.4, color = NA, adjust = 1.0) +
  geom_vline(data = group_means, aes(xintercept = mean_slope, color = status),
             linewidth = 0.9, show.legend = FALSE) +
  theme_bw(base_size = 12) +
  labs(x = "Slope of eventpl_w on PA (subject-specific)", y = "Density")
```

![](4_files/figure-gfm/unnamed-chunk-25-1.png)<!-- -->

**Within-person moderation**

``` r
# fit moderation model
m10 <- lme(pa ~ eventpl_w * soc_alone, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.exclude)

summary(m10)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39460.81 39521.17 -19722.41
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9519437 (Intr)
    ## eventpl_w   0.1051428 -0.331
    ## Residual    0.9411401       
    ## 
    ## Fixed effects:  pa ~ eventpl_w * soc_alone 
    ##                         Value  Std.Error    DF  t-value p-value
    ## (Intercept)          4.609327 0.05369224 13641 85.84718  0.0000
    ## eventpl_w            0.192434 0.00927860 13641 20.73951  0.0000
    ## soc_alone           -0.140265 0.01777362 13641 -7.89173  0.0000
    ## eventpl_w:soc_alone -0.011059 0.01115748 13641 -0.99116  0.3216
    ##  Correlation: 
    ##                     (Intr) evntp_ soc_ln
    ## eventpl_w           -0.212              
    ## soc_alone           -0.131  0.039       
    ## eventpl_w:soc_alone  0.009 -0.483 -0.012
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.84254614 -0.50432154  0.09379427  0.58901204  4.40188492 
    ## 
    ## Number of Observations: 13972
    ## Number of Groups: 328

``` r
# fit moderation model with random effect
m11 <- lme(pa ~ eventpl_w * soc_alone, 
          random = ~eventpl_w * soc_alone|id,
          data = data, 
          na.action = na.exclude)

summary(m11)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   39458.37 39571.54 -19714.19
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w * soc_alone | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##                     StdDev     Corr                
    ## (Intercept)         0.94158803 (Intr) evntp_ soc_ln
    ## eventpl_w           0.10219234 -0.386              
    ## soc_alone           0.16477595  0.115 -0.158       
    ## eventpl_w:soc_alone 0.05110001  0.290 -0.013 -0.163
    ## Residual            0.93755080                     
    ## 
    ## Fixed effects:  pa ~ eventpl_w * soc_alone 
    ##                         Value  Std.Error    DF  t-value p-value
    ## (Intercept)          4.610299 0.05314838 13641 86.74393  0.0000
    ## eventpl_w            0.192156 0.00913958 13641 21.02459  0.0000
    ## soc_alone           -0.137483 0.02014576 13641 -6.82444  0.0000
    ## eventpl_w:soc_alone -0.010235 0.01161990 13641 -0.88084  0.3784
    ##  Correlation: 
    ##                     (Intr) evntp_ soc_ln
    ## eventpl_w           -0.243              
    ## soc_alone           -0.067 -0.010       
    ## eventpl_w:soc_alone  0.078 -0.467 -0.031
    ## 
    ## Standardized Within-Group Residuals:
    ##         Min          Q1         Med          Q3         Max 
    ## -5.87168776 -0.50311017  0.09191027  0.58480493  4.41928233 
    ## 
    ## Number of Observations: 13972
    ## Number of Groups: 328

**Fixed-effects interaction plot**

``` r
# fixed effects & VCOV
fe <- fixef(m10) 
VC <- vcov(m10)
xseq <- seq(min(data$eventpl_w, na.rm=TRUE), 
            max(data$eventpl_w, na.rm=TRUE), length.out=100)
levs <- levels(factor(data$soc_alone))
grid <- expand.grid(eventpl_w = xseq, soc_alone = levs)
grid$soc_alone <- factor(grid$soc_alone, levels = levs)

# design, preds, SEs
X <- model.matrix(~ eventpl_w * soc_alone, data = grid)
grid$yhat <- as.numeric(X %*% fe)
grid$se   <- sqrt(rowSums((X %*% VC) * X))
grid <- grid %>% mutate(lwr = yhat - 1.96*se, upr = yhat + 1.96*se)

# plot
ggplot(grid, aes(eventpl_w, yhat, color = soc_alone, fill = soc_alone)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = .2, color = NA) +
  geom_line(linewidth = 1.1) + theme_bw(base_size = 12) +
  labs(x = "Event pleasantness (within-person)", 
       y = "Predicted positive affect (PA)",
       color = "Context", fill = "Context")
```

![](4_files/figure-gfm/unnamed-chunk-28-1.png)<!-- -->

# Within-person mediation analysis

<figure>
<img src="https://upload.wikimedia.org/wikipedia/commons/f/f8/Simple_Mediation_Model.png">
</figure>

**Prepare double-entry, stacked dataset**

``` r
# select variables
data_med <- data[, c("id", "obs", "use_alcohol", "eventpl_w", "pa")]
data_med$m <- data_med$eventpl_w

# melt y and m into z
data_med <- melt(data_med,
                 id.vars   = c("id", "obs", "use_alcohol", "eventpl_w"),
                 measure.vars = c("m","pa"),              
                 variable.name = "dv",
                 value.name    = "z")

# adding dummy variables
data_med$dv <- factor(data_med$dv, levels = c("m","pa"))  # mediator first
data_med$dm <- as.integer(data_med$dv == "m")
data_med$dy <- as.integer(data_med$dv == "pa")
data_med$obs <- scale(data_med$obs, center = TRUE, scale = FALSE)

# order by id and time
data_med <- data_med[order(data_med$id,data_med$obs),]
```

**Fit mediation model**

``` r
               # intercepts
m_med <- lme(z ~ 0 + dm + dy +  
               # prediction of mediator 
               dm:use_alcohol + 
               # prediction of outcome
               dy:eventpl_w + dy:use_alcohol,
               # random effects for all three paths
               random = ~ 0 + dm + dy | id,  
               # separate residual variance for each outcome
               weights = varIdent(form = ~ 1 | dv), 
               data = data_med,
               na.action = na.exclude,
               control = lmeControl(opt = "optim"))

summary(m_med)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data_med 
    ##        AIC      BIC    logLik
    ##   91351.77 91434.08 -45665.88
    ## 
    ## Random effects:
    ##  Formula: ~0 + dm + dy | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##          StdDev       Corr 
    ## dm       1.718345e-07 dm   
    ## dy       9.547036e-01 0.013
    ## Residual 1.567997e+00      
    ## 
    ## Variance function:
    ##  Structure: Different standard deviations per stratum
    ##  Formula: ~1 | dv 
    ##  Parameter estimates:
    ##         m        pa 
    ## 1.0000000 0.6107956 
    ## Fixed effects:  z ~ 0 + dm + dy + dm:use_alcohol + dy:eventpl_w + dy:use_alcohol 
    ##                    Value  Std.Error    DF  t-value p-value
    ## dm             -0.019137 0.01370750 27422 -1.39609  0.1627
    ## dy              4.539088 0.05346245 27422 84.90235  0.0000
    ## dm:use_alcohol  0.321101 0.05599887 27422  5.73407  0.0000
    ## dy:eventpl_w    0.191972 0.00519564 27422 36.94867  0.0000
    ## dy:use_alcohol  0.232952 0.03648252 27422  6.38529  0.0000
    ##  Correlation: 
    ##                dm     dy     dm:s_l dy:vn_
    ## dy              0.000                     
    ## dm:use_alcohol -0.245  0.000              
    ## dy:eventpl_w    0.000  0.002  0.000       
    ## dy:use_alcohol  0.000 -0.043  0.000 -0.052
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -5.8918408 -0.4906418  0.1610145  0.6499611  3.8868289 
    ## 
    ## Number of Observations: 27754
    ## Number of Groups: 328

`dm` - intercept when `m` is the outcome  
`dy` - intercept when `y` is the outcome  
`dm:use_alcohol` - effect of `x` when `m` is the outcome (i.e., `a`
path)  
`dy:eventpl_w` - effect of `m` when `y` is the outcome (i.e., `b`
path)  
`dy:use_alcohol` - effect of `x` when `y` is the outcome (i.e., `c`
path)

# Lagged analysis

``` r
# create lagged pa 
data <- data %>%
  arrange(id, obs) %>%                
  group_by(id) %>%     
  mutate(pa_l1 = lag(pa, n = 1)) %>% 
  mutate(pa_l1 = if_else(beep == 1, NA, pa_l1)) %>%
  ungroup()

# fit model with lagged eventpl
m12 <- lme(pa ~ eventpl_w_l1 + pa_l1, 
          random = ~eventpl_w_l1 + pa_l1|id,
          data = data, 
          na.action = na.exclude)

summary(m12)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   30295.19 30368.06 -15137.59
    ## 
    ## Random effects:
    ##  Formula: ~eventpl_w_l1 + pa_l1 | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##              StdDev     Corr         
    ## (Intercept)  0.97413859 (Intr) evn__1
    ## eventpl_w_l1 0.05852799  0.05        
    ## pa_l1        0.17107683 -0.80  -0.24 
    ## Residual     0.93143182              
    ## 
    ## Fixed effects:  pa ~ eventpl_w_l1 + pa_l1 
    ##                  Value  Std.Error    DF  t-value p-value
    ## (Intercept)  2.9422711 0.07340961 10471 40.08019  0.0000
    ## eventpl_w_l1 0.0064966 0.00712790 10471  0.91144  0.3621
    ## pa_l1        0.3574549 0.01408037 10471 25.38675  0.0000
    ##  Correlation: 
    ##              (Intr) evn__1
    ## eventpl_w_l1  0.171       
    ## pa_l1        -0.883 -0.250
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -5.9819896 -0.4828658  0.1012140  0.5648072  4.0699718 
    ## 
    ## Number of Observations: 10801
    ## Number of Groups: 328

# VAR model

<figure>
<img src="https://lennartseizer.github.io/ild/4/4_files/figure-gfm/var.png">
</figure>

**Prepare variables**

``` r
# pa
data$pa_b <- ave(data$pa, data$id, 
                 FUN=function(x)mean(x, na.rm = TRUE)) 
data$pa_w <- data$pa - data$pa_b 
data <- data %>%
  arrange(id, obs) %>%                
  group_by(id) %>%     
  mutate(pa_w_l1 = lag(pa_w, n = 1)) %>% 
  mutate(pa_w_l1 = if_else(beep == 1, NA, pa_w_l1)) %>%
  ungroup()

# na
data$na_b <- ave(data$na, data$id, 
                 FUN=function(x)mean(x, na.rm = TRUE)) 
data$na_w <- data$na - data$na_b 
data <- data %>%
  arrange(id, obs) %>%                
  group_by(id) %>%     
  mutate(na_w_l1 = lag(na_w, n = 1)) %>% 
  mutate(na_w_l1 = if_else(beep == 1, NA, na_w_l1)) %>%
  ungroup()
```

**VAR part 1**

``` r
# b11, b21, sigma11
var1 <- lme(pa ~ pa_w_l1 + na_w_l1,
            random = ~pa_w_l1 + na_w_l1|id,
            data = data,
            na.action = na.exclude)

summary(var1)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   31664.46 31737.75 -15822.23
    ## 
    ## Random effects:
    ##  Formula: ~pa_w_l1 + na_w_l1 | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr         
    ## (Intercept) 0.9638611 (Intr) p_w_l1
    ## pa_w_l1     0.1772032 -0.231       
    ## na_w_l1     0.2361110 -0.164  0.378
    ## Residual    0.9222395              
    ## 
    ## Fixed effects:  pa ~ pa_w_l1 + na_w_l1 
    ##                 Value  Std.Error    DF  t-value p-value
    ## (Intercept)  4.570179 0.05401929 10926 84.60272   0e+00
    ## pa_w_l1      0.259845 0.01580708 10926 16.43855   0e+00
    ## na_w_l1     -0.085920 0.02438674 10926 -3.52322   4e-04
    ##  Correlation: 
    ##         (Intr) p_w_l1
    ## pa_w_l1 -0.142       
    ## na_w_l1 -0.088  0.480
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -6.0330735 -0.4824995  0.1025902  0.5625489  4.2131443 
    ## 
    ## Number of Observations: 11256
    ## Number of Groups: 328

**VAR part 2**

``` r
# b21, b22, sigma22
var2 <- lme(na ~ pa_w_l1 + na_w_l1,
            random = ~pa_w_l1 + na_w_l1|id,
            data = data,
            na.action = na.exclude)

summary(var2)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data 
    ##        AIC      BIC    logLik
    ##   21171.13 21244.38 -10575.56
    ## 
    ## Random effects:
    ##  Formula: ~pa_w_l1 + na_w_l1 | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev     Corr         
    ## (Intercept) 0.72152616 (Intr) p_w_l1
    ## pa_w_l1     0.08025303 -0.598       
    ## na_w_l1     0.22044634  0.022  0.383
    ## Residual    0.57781206              
    ## 
    ## Fixed effects:  na ~ pa_w_l1 + na_w_l1 
    ##                  Value  Std.Error    DF  t-value p-value
    ## (Intercept)  1.7129088 0.04026299 10883 42.54301   0e+00
    ## pa_w_l1     -0.0337596 0.00871811 10883 -3.87235   1e-04
    ## na_w_l1      0.2819011 0.01861064 10883 15.14731   0e+00
    ##  Correlation: 
    ##         (Intr) p_w_l1
    ## pa_w_l1 -0.302       
    ## na_w_l1  0.014  0.469
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -5.4142290 -0.4124326 -0.1227371  0.2485783  6.7165943 
    ## 
    ## Number of Observations: 11213
    ## Number of Groups: 328

**VAR part 3**

``` r
# sigma 12
cov(residuals(var1), residuals(var2), use = "complete.obs")
```

    ## [1] -0.292775

# Model diagnostics

**Fit model**

``` r
m3 <- lme(pa ~ eventpl_w, 
          random = ~eventpl_w|id,
          data = data, 
          na.action = na.exclude)
```

**L1 residuals**

``` r
# prepare residuals/predictions
res  <- residuals(m3, type = "normalized")
pred <- fitted(m3)
df   <- data.frame(res = as.numeric(res), pred = as.numeric(pred))

# density of residuals
p_dens <- ggplot(df, aes(x = res)) + geom_density() +
  labs(title = "Distribution of Level-1 residuals", x = "Residual", 
       y = "Density") +
  theme_bw()

# q-q plot
p_qq <- ggplot(df, aes(sample = res)) + stat_qq() + stat_qq_line() +
  labs(title = "Q-Q Plot of Level-1 residuals", 
       x = "Theoretical quantiles", y = "Sample quantiles") +
  theme_bw()

# predicted vs residuals
p_scatter <- ggplot(df, aes(x = pred, y = res)) + geom_point(alpha=0.4) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 0.6) +
  labs(title = "Predicted vs Residuals", x = "Predicted", 
       y = "Residuals") +
  theme_bw()

# ACF of residuals 
acf_obj <- acf(df$res, plot = FALSE, na.action = na.pass)
n_used <- acf_obj$n.used
ci <- qnorm(0.975) / sqrt(n_used)

acf_df <- data.frame(
  lag = as.numeric(acf_obj$lag) * n_used,
  acf = as.numeric(acf_obj$acf)
) %>% filter(lag > 0)

p_acf <- ggplot(acf_df, aes(x = lag, y = acf)) +
  geom_hline(yintercept = 0, linetype = "solid") +
  geom_hline(yintercept = c(-ci, ci), linetype = "dashed") +
  geom_segment(aes(xend = lag, y = 0, yend = acf)) +
  labs(title = "ACF of Level-1 residuals", x = "Lag", y = "ACF") +
  theme_bw() + ylim(c(-.1,.25))

cowplot::plot_grid(p_dens, p_qq, p_scatter, p_acf)
```

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_density()`).

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_qq()`).

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_qq_line()`).

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_smooth()`).

    ## Warning: Removed 5641 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

![](4_files/figure-gfm/unnamed-chunk-37-1.png)<!-- -->

**Fit model with AR errors**

``` r
m3_ar <- lme(pa ~ eventpl_w, 
             random = ~eventpl_w|id,
             data = data, 
             na.action = na.exclude,
             correlation = corAR1(form = ~beep|id/day))
```

**L1 residuals**

``` r
# prepare residuals/predictions
res  <- residuals(m3_ar, type = "normalized")
pred <- fitted(m3_ar)
df   <- data.frame(res = as.numeric(res), pred = as.numeric(pred))

# density of residuals
p_dens <- ggplot(df, aes(x = res)) + geom_density() +
  labs(title = "Distribution of Level-1 residuals", x = "Residual", 
       y = "Density") + theme_bw()

# q-q plot
p_qq <- ggplot(df, aes(sample = res)) + stat_qq() + stat_qq_line() +
  labs(title = "Q-Q Plot of Level-1 residuals", 
       x = "Theoretical quantiles", y = "Sample quantiles") + theme_bw()

# predicted vs residuals
p_scatter <- ggplot(df, aes(x = pred, y = res)) + geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 0.6) +
  labs(title = "Predicted vs Residuals", x = "Predicted", 
       y = "Residuals") + theme_bw()

# ACF of residuals 
acf_obj <- acf(df$res, plot = FALSE, na.action = na.pass)
n_used <- acf_obj$n.used
ci <- qnorm(0.975) / sqrt(n_used)

acf_df <- data.frame(
  lag = as.numeric(acf_obj$lag) * n_used,
  acf = as.numeric(acf_obj$acf)
) %>% filter(lag > 0)

p_acf <- ggplot(acf_df, aes(x = lag, y = acf)) +
  geom_hline(yintercept = 0, linetype = "solid") +
  geom_hline(yintercept = c(-ci, ci), linetype = "dashed") +
  geom_segment(aes(xend = lag, y = 0, yend = acf)) +
  labs(title = "ACF of Level-1 residuals", x = "Lag", y = "ACF") +
  theme_bw() + ylim(c(-.1,.25))

# plot
cowplot::plot_grid(p_dens, p_qq, p_scatter, p_acf)
```

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_density()`).

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_qq()`).

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_qq_line()`).

    ## Warning: Removed 5641 rows containing non-finite outside the scale range
    ## (`stat_smooth()`).

    ## Warning: Removed 5641 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

![](4_files/figure-gfm/unnamed-chunk-39-1.png)<!-- -->

**L2 residuals**

``` r
# extract random effects 
re_int <- as.numeric(ranef(m3_ar)[,"(Intercept)"]) #level-2 intercepts
re_slope <- as.numeric(ranef(m3_ar)[,"eventpl_w"]) #level-2 slopes 

df_int <- data.frame(effect = re_int)
df_slope <- data.frame(effect = re_slope)

# intercept residuals
p_int_dens <- ggplot(df_int, aes(x = effect)) + geom_density() +
  labs(title = "Distribution of intercept residuals", 
       x = "Intercept BLUP", y = "Density") + theme_bw()

p_int_qq <- ggplot(df_int, aes(sample = effect)) + stat_qq() + stat_qq_line() +
  labs(title = "Q–Q Plot of intercept residuals", 
       x = "Theoretical quantiles", y = "Sample quantiles") + theme_bw()

# slope residuals
p_slope_dens <- ggplot(df_slope, aes(x = effect)) + geom_density() +
  labs(title = "Distribution of slope residuals", 
       x = "eventpl_w slope BLUP", y = "Density") + theme_bw()

p_slope_qq <- ggplot(df_slope, aes(sample = effect)) + stat_qq() + stat_qq_line() +
  labs(title = "Q–Q Plot of slope residuals", 
       x = "Theoretical quantiles", y = "Sample quantiles") + theme_bw()

# plot
cowplot::plot_grid(p_int_dens, p_int_qq, p_slope_dens, p_slope_qq)
```

![](4_files/figure-gfm/unnamed-chunk-40-1.png)<!-- -->

**Outliers / Influential observations**

``` r
m3_infl <- hlm_influence(m3, level = "id")
dotplot_diag(m3_infl$cooksd, name = "cooks.distance", cutoff = 4/328)
```

![](4_files/figure-gfm/unnamed-chunk-41-1.png)<!-- -->

# Standardized / additional outputs

**Confidence intervals**

``` r
# 95% CI
intervals(m3, level = .95)
```

    ## Approximate 95% confidence intervals
    ## 
    ##  Fixed effects:
    ##                 lower     est.     upper
    ## (Intercept) 4.4489742 4.553894 4.6588135
    ## eventpl_w   0.1736068 0.189554 0.2055012
    ## 
    ##  Random Effects:
    ##   Level: id 
    ##                                  lower       est.      upper
    ## sd((Intercept))             0.89827652  0.9573947  1.0204037
    ## sd(eventpl_w)               0.09175886  0.1056456  0.1216339
    ## cor((Intercept),eventpl_w) -0.45754176 -0.3266818 -0.1819711
    ## 
    ##  Within-group standard error:
    ##     lower      est.     upper 
    ## 0.9324335 0.9436210 0.9549427

**Standardized coefficients**

``` r
standardize_parameters(m3)
```

    ## # Standardization method: refit
    ## 
    ## Parameter   | Std. Coef. |        95% CI
    ## ----------------------------------------
    ## (Intercept) |  -2.40e-03 | [-0.08, 0.07]
    ## eventpl w   |       0.21 | [ 0.20, 0.23]

**Cohen’s d** Framework:  
<https://doi.org/10.1037/a0014699>, <https://doi.org/10.1037/a0030048>

Detailed tutorial:  
<https://solomonkurz.netlify.app/blog/2021-04-22-effect-sizes-for-experimental-trials-analyzed-with-multilevel-growth-models-two-of-two/>

d<sub>GMA</sub> = ( b<sub>int</sub> × time ) / SD<sub>pooled</sub>     
SD<sub>pooled</sub> = √\[ ( SD<sup>2</sup><sub>c0</sub> +
SD<sup>2</sup><sub>t0</sub> ) / 2 \]

``` r
# fit model
m13 <- lme(pa ~ day * status, 
           random = ~day|id,
           data = data[!data$status == "depressed",], 
           na.action = na.exclude)

summary(m13)
```

    ## Linear mixed-effects model fit by REML
    ##   Data: data[!data$status == "depressed", ] 
    ##        AIC      BIC    logLik
    ##   25996.32 26053.71 -12990.16
    ## 
    ## Random effects:
    ##  Formula: ~day | id
    ##  Structure: General positive-definite, Log-Cholesky parametrization
    ##             StdDev    Corr  
    ## (Intercept) 0.9231431 (Intr)
    ## day         0.1418058 -0.329
    ## Residual    0.8756421       
    ## 
    ## Fixed effects:  pa ~ day * status 
    ##                         Value  Std.Error   DF  t-value p-value
    ## (Intercept)          5.156396 0.09159298 9429 56.29685  0.0000
    ## day                  0.008130 0.01528720 9429  0.53182  0.5949
    ## statuspsychotic     -0.730330 0.13155479  217 -5.55153  0.0000
    ## day:statuspsychotic -0.028749 0.02209541 9429 -1.30113  0.1932
    ##  Correlation: 
    ##                     (Intr) day    sttsps
    ## day                 -0.406              
    ## statuspsychotic     -0.696  0.283       
    ## day:statuspsychotic  0.281 -0.692 -0.411
    ## 
    ## Standardized Within-Group Residuals:
    ##        Min         Q1        Med         Q3        Max 
    ## -6.2089455 -0.4454171  0.1055160  0.5416973  4.4546423 
    ## 
    ## Number of Observations: 9650
    ## Number of Groups: 219

``` r
# psychotic sd_d1
sd_d1_p <- sd(data$pa[data$status=="psychotic" & data$day==1], na.rm=T)

# control sd_d1
sd_d1_c <- sd(data$pa[data$status=="control" & data$day==1], na.rm=T)

# pooled sd
pooled_sd <- sqrt((sd_d1_p^2 + sd_d1_c^2) / 2)

# d_gma
as.numeric(fixef(m10)["day:statuspsychotic"]) * 5 / pooled_sd
```

    ## [1] NA

# Exercises

> 1.  1)  Estimate a model that predicts negative affect (`na`) based on
>         whether participants are alone or with others `soc_alone`. (b)
>         Test whether the previous effect is moderated by how pleasant
>         the company of others is experienced `soc_pleasant`. Pick an
>         appropriate random effects structure and check model
>         assumptions.
> 2.  1)  Estimate the time trend of negative affect (`na`) over the
>         study period, and (b) whether this time trend differs between
>         mental health status groups (`status`). Report standardized
>         effect sizes for the time:group interactions.
